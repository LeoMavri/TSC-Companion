// ==UserScript==
// @name         TSC Companion - Next
// @namespace    TSC
// @version      next-7
// @author       mavri [2402357]
// @description  A very early version of the new TSC Companion. Special thanks to Kwack [2190604]
// @copyright    2024, diicot.cc
// @icon         https://i.imgur.com/8eydsOA.png
// @updateURL    https://github.com/LeoMavri/TSC-Companion/raw/next/dist/tsc-companion.user.js
// @match        https://www.torn.com/profiles.php?*
// @match        https://www.torn.com/factions.php*
// @connect      api.torn.com
// @connect      tsc.diicot.cc
// @grant        GM.xmlHttpRequest
// @grant        GM_addStyle
// @run-at       document-end
// ==/UserScript==

(o=>{if(typeof GM_addStyle=="function"){GM_addStyle(o);return}const r=document.createElement("style");r.textContent=o,document.head.append(r)})(" body{--tsc-bg-color: #f0f0f0;--tsc-border-color: #ccc;--tsc-input-color: #ccc;--tsc-text-color: #000;--tsc-hover-color: #ddd}body.dark-mode{--tsc-bg-color: #333;--tsc-border-color: #444;--tsc-input-color: #504f4f;--tsc-text-color: #ccc;--tsc-hover-color: #555}table.tsc-stat-table{width:100%;border-collapse:collapse;color:var(--tsc-text-color);background-color:var(--tsc-bg-color)}table.tsc-stat-table th,table.tsc-stat-table td{border:1px solid var(--tsc-border-color);color:var(--tsc-text-color);padding:5px;text-align:center}table.tsc-stat-table th{background-color:var(--tsc-bg-color);color:var(--tsc-text-color)}.tsc-faction-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer}.tsc-accordion{background-color:var(--tsc-bg-color);border:1px solid var(--tsc-border-color);border-radius:5px;margin:10px 0;padding:10px}.tsc-setting-entry{display:flex;align-items:center;gap:5px;margin-top:10px;margin-bottom:5px}.tsc-key-input{width:120px;padding-left:5px;background-color:var(--tsc-input-color);color:var(--tsc-text-color)}.tsc-button{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:5px 10px;cursor:pointer}.tsc-button:hover{background-color:var(--tsc-hover-color)}.tsc-blur{filter:blur(3px);transition:filter 2s}.tsc-blur:hover{filter:blur(0)} ");

(function () {
	'use strict';

	var C=Object.defineProperty;var k=(a,t,e)=>t in a?C(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var u=(a,t,e)=>(k(a,typeof t!="symbol"?t+"":t,e),e);const g={Debug:!0,Colours:{Info:"#05668D",Warn:"#EDDEA4",Error:"#ff0000",Debug:"#5C415D"}};class o{static info(t,...e){console.info(`%c[TSC Companion] ${t}`,`color: ${g.Colours.Info}`,...e);}static warn(t,...e){console.log(`%c[TSC Companion] ${t}`,`color: ${g.Colours.Warn}`,...e);}static error(t,...e){console.error(`%c[TSC Companion] ${t}`,`color: ${g.Colours.Error}`,...e);}static debug(t,...e){console.log(`%c[TSC Companion] ${t}`,`color: ${g.Colours.Debug}`,...e);}}class f{constructor({name:t,description:e,shouldRun:n,start:i}){u(this,"name");u(this,"description");u(this,"shouldRun");u(this,"start");this.name=t,this.description=e,this.shouldRun=n,this.start=i;}}class T{constructor(t){u(this,"storageKey");this.storageKey=t;}getToggle(t){return this.getSetting(t)==="true"}getSetting(t){return localStorage.getItem(`${this.storageKey}-${t}`)}setSetting(t,e){localStorage.setItem(`${this.storageKey}-${t}`,e);}getJSON(t){const e=this.getSetting(t);return e===null?null:JSON.parse(e)}setJSON(t,e){this.setSetting(t,JSON.stringify(e));}fullClear(){let t=0;for(let e=0;e<localStorage.length;e++){const n=localStorage.key(e);n!=null&&n.startsWith(this.storageKey)&&(localStorage.removeItem(n),o.debug(`Cleared ${n}`),++t);}return t}spyClear(){let t=0;for(let e=0;e<localStorage.length;e++){const n=localStorage.key(e);n!=null&&n.startsWith(`${this.storageKey}-spy`)&&(localStorage.removeItem(n),o.debug(`Cleared ${n}`),++t);}return t}}const r=new T("kwack.mavri.tsc.rocks");function h(a,t){return new Promise((e,n)=>{let i;if(document.querySelectorAll(a).length)return e(document.querySelector(a));const s=new MutationObserver(()=>{if(document.querySelectorAll(a).length)return s.disconnect(),i!=null&&clearTimeout(i),e(document.querySelector(a))});s.observe(document.body,{childList:!0,subtree:!0}),t&&(i=setTimeout(()=>{s.disconnect(),e(null);},t));})}const v=12*60*60*1e3;function w(a,t){const e=r.getJSON(`spy-${a}`);if(e){if(e.insertedAt&&new Date().getTime()-new Date(e.insertedAt).getTime()<v)return o.debug("Spy cache still valid"),Promise.resolve(e);o.debug("Spy cache expired, fetching new data"),r.setJSON(`spy-${a}`,null);}return new Promise((n,i)=>{(GM.xmlHttpRequest??GM.xmlhttpRequest)({method:"POST",url:"https://tsc.diicot.cc/stats/update",headers:{authorization:"10000000-6000-0000-0009-000000000001","x-requested-with":"XMLHttpRequest","Content-Type":"application/json"},data:JSON.stringify({apiKey:t,userId:a}),onload(d){const c=JSON.parse(d.responseText);console.log(c),!("error"in c)&&c.success&&r.setJSON(`spy-${a}`,{...c,insertedAt:new Date().getTime()}),n(c);},onerror(){i({success:!1,code:999});},timeout:5e3});})}function l(a,t=2){return Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:t,minimumFractionDigits:t}).format(a)}const P=new f({name:"Profile Page",description:"Shows a user's spy on their profile page",shouldRun:async function(){return r.getToggle(this.name)&&window.location.pathname==="/profiles.php"},start:async()=>{const a=await h(".empty-block",15e3);if(a===null){o.warn("Could not find the empty block on the profile page");return}const t=window.location.search.split("XID=")[1],e=r.getSetting("api-key");if(!e){o.warn("No API key found, cannot fetch spy");return}const n=await w(t,e);if("error"in n){o.error(n.message);return}if(!n.success){o.error(`Failed to fetch spy: ${n.code}`);return}const{estimate:i,statInterval:s}=n.spy;$(a).append($("<table>").addClass("tsc-stat-table").append($("<tr>").append($("<th>").text("Estimated Stats")).append($("<th>").text("Min")).append($("<th>").text("Max")).append($("<th>").text("Battle Score"))).append($("<tr>").append($("<td>").text(l(BigInt(i.stats)))).append($("<td>").text(s!=null&&s.battleScore?l(BigInt(s.min)):"N/A")).append($("<td>").text(s!=null&&s.battleScore?l(BigInt(s.max)):"N/A")).append($("<td>").text(s!=null&&s.battleScore?s.battleScore:"N/A"))));}}),I=new f({name:"Faction - Normal",description:"Shows a list of spies on the faction page",shouldRun:async function(){return r.getToggle(this.name)&&window.location.href.includes("factions.php?step=profile")},start:async function(){const a=await h(".faction-info-wrap.restyle.another-faction .table-body > li:nth-child(1)",15e3);if(a===null){o.warn(`${this.name}: Failed to find element to append to.`);return}const t=$(a).parent().parent()[0];$(t).find("li").each((e,n)=>{const i=$(n).find('[class*="userInfoBox"]')[0];//! This is a bit of a hack, but it works for now
	if($(i).css("width","157px"),i===void 0)return;const s=$(i).find('a[href^="/profiles.php?XID="]')[0];if(s===void 0)return;const d=s.href.split("XID=")[1];w(d,r.getSetting("api-key")).then(c=>{if("error"in c||c.success!==!0){o.warn(`Failed to find spy for ${d}`,c);return}const{estimate:m,statInterval:p}=c.spy;let y=l(m.stats,1),b=`Estimate: ${l(m.stats,2)}`;p!=null&&p.battleScore&&(y=`${l(BigInt(p.min),1)} - ${l(BigInt(p.max),1)}`,b+=`<br>Interval: ${l(BigInt(p.min),2)} - ${l(BigInt(p.max),2)}<br>Battle Score: ${l(p.battleScore,2)}`),$(i).after($("<div>").addClass("tsc-faction-spy").text(y).attr("title",b));});});}}),x=Object.freeze(Object.defineProperty({__proto__:null,FactionNormal:I,ProfilePage:P},Symbol.toStringTag,{value:"Module"})),S=new f({name:"Settings Panel",description:"Adds a settings panel to your own faction page.",shouldRun:async function(){return window.location.href.includes("factions.php?step=your")},start:async function(){var e;const a=await h("#factions > ul",15e3);if(a===null){o.warn(`${this.name}: Failed to find element to append to.`);return}if((e=a.nextElementSibling)!=null&&e.classList.contains("tsc-accordion")){o.warn(`${this.name}: Element already exists`);return}const t=Object.values(x);o.debug("Features:",t),$(a).after($("<details>").addClass("tsc-accordion").append($("<summary>").text("TSC Settings")).append($("<p>").css("margin-top","5px").text("This is the settings panel for the Torn Spies Central script."),$("<p>").text("Here you can configure the settings to your liking. Please note that changes will be saved automatically."),$("<br>"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","enable").prop("checked",r.getToggle("enable")).on("change",function(){r.setSetting("enable",$(this).prop("checked")),o.debug(`Set enable to ${$(this).prop("checked")}`);})).append($("<p>").text("Enable Script")),$("<div>").addClass("tsc-setting-entry").append($("<label>").attr("for","api-key").text("API Key"),$("<input>").attr("type","text").attr("id","api-key").attr("placeholder","Paste your key here...").addClass("tsc-key-input").addClass("tsc-blur").val(r.getSetting("api-key")||"").on("change",function(){const n=$(this).val();if(typeof n!="string"){o.warn("API Key is not a string.");return}if(!/^[a-zA-Z0-9]{16}$/.test(n)){o.warn("API Key is not valid."),$(this).css("outline","1px solid red");return}$(this).css("outline","none"),n!==r.getSetting("api-key")&&(r.setSetting("api-key",n),o.debug(`Set api-key to ${n}`));})),$("<br>"),$("<p>").text("Feature toggles:"),t.map(n=>$("<div>").append($("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id",n.name).prop("checked",r.getToggle(n.name)).on("change",function(){r.setSetting(n.name,$(this).prop("checked")),o.debug(`Set ${n.name} to ${$(this).prop("checked")}`);})).append($("<p>").text(n.name))).append($("<p>").text(n.description))),$("<br>"),$("<br>"),$("<p>").text("The following buttons need to be double clicked to prevent accidental clicks.").css("margin-bottom","10px"),$("<button>").text("Clear cached spies").addClass("tsc-button").css("margin-right","10px").on("dblclick",async function(){const n=r.spyClear();o.debug("Cleared all cached spies");const i=$(this);i.animate({opacity:0},"slow",function(){i.text(`Cleared ${n} spies`);}).animate({opacity:1},"slow"),setTimeout(function(){i.animate({opacity:0},"slow",function(){i.text("Clear cached spies");}).animate({opacity:1},"slow");},3e3);}),$("<button>").text("Clear all cache").addClass("tsc-button").on("dblclick",async function(){const n=r.fullClear();o.debug("Cleared all cache");const i=$(this);i.animate({opacity:0},"slow",function(){i.text(`Cleared ${n} items`);}).animate({opacity:1},"slow"),setTimeout(function(){i.animate({opacity:0},"slow",function(){i.text("Clear all cache");}).animate({opacity:1},"slow");},3e3);})));}});async function N(){if(await S.shouldRun()===!0&&(o.info("Settings panel feature started"),await S.start()),r.getToggle("enable")===!1){o.info("TSC is disabled");return}o.info("Starting TSC features...");for(const a of Object.values(x)){if(await a.shouldRun()===!1){o.info(`${a.name} feature not applicable`);continue}try{await a.start(),o.info(`${a.name} feature started`);}catch(t){o.error(`Failed to start ${a.name} feature:`,t);}}}N().catch(a=>{o.error("TSC failed catastrophically:",a);});

})();