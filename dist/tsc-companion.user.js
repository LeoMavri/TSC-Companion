// ==UserScript==
// @name         TSC Companion - Next
// @namespace    TSC
// @version      next-3
// @author       mavri [2402357]
// @description  A very early version of the new TSC Companion. Special thanks to Kwack [2190604]
// @copyright    2024, diicot.cc
// @icon         https://i.imgur.com/8eydsOA.png
// @updateURL    https://github.com/LeoMavri/TSC-Companion/raw/next/dist/tsc-companion.user.js
// @match        https://www.torn.com/profiles.php?*
// @match        https://www.torn.com/factions.php?step=your*
// @connect      api.torn.com
// @connect      tsc.diicot.cc
// @grant        GM.xmlHttpRequest
// @grant        GM_addStyle
// @run-at       document-end
// ==/UserScript==

(t=>{if(typeof GM_addStyle=="function"){GM_addStyle(t);return}const o=document.createElement("style");o.textContent=t,document.head.append(o)})(" body{--tsc-bg-color: #f0f0f0;--tsc-border-color: #ccc;--tsc-input-color: #ccc;--tsc-text-color: #000}body.dark-mode{--tsc-bg-color: #333;--tsc-border-color: #444;--tsc-input-color: #504f4f;--tsc-text-color: #ccc}table.tsc-stat-table{width:100%;border-collapse:collapse;color:var(--tsc-text-color);background-color:var(--tsc-bg-color)}table.tsc-stat-table th,table.tsc-stat-table td{border:1px solid var(--tsc-border-color);color:var(--tsc-text-color);padding:5px;text-align:center}table.tsc-stat-table th{background-color:var(--tsc-bg-color);color:var(--tsc-text-color)}.tsc-accordion{background-color:var(--tsc-bg-color);border:1px solid var(--tsc-border-color);border-radius:5px;margin:10px 0;padding:10px}.tsc-setting-entry{display:flex;align-items:center;gap:5px;margin-bottom:5px}.tsc-key-input{width:120px;padding-left:5px;background-color:var(--tsc-input-color);color:var(--tsc-text-color)}.tsc-blur{filter:blur(3px);transition:filter 2s}.tsc-blur:hover{filter:blur(0)} ");

(function () {
	'use strict';

	var y=Object.defineProperty;var S=(n,e,t)=>e in n?y(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>(S(n,typeof e!="symbol"?e+"":e,t),t);const p={Debug:!0,Colours:{Info:"#05668D",Warn:"#EDDEA4",Error:"#ff0000",Debug:"#5C415D"}};class a{static info(e,...t){console.info(`%c[TSC Companion] ${e}`,`color: ${p.Colours.Info}`,...t);}static warn(e,...t){console.log(`%c[TSC Companion] ${e}`,`color: ${p.Colours.Warn}`,...t);}static error(e,...t){console.error(`%c[TSC Companion] ${e}`,`color: ${p.Colours.Error}`,...t);}static debug(e,...t){console.log(`%c[TSC Companion] ${e}`,`color: ${p.Colours.Debug}`,...t);}}class g{constructor({name:e,description:t,shouldRun:r,start:i}){c(this,"name");c(this,"description");c(this,"shouldRun");c(this,"start");this.name=e,this.description=t,this.shouldRun=r,this.start=i;}}class b{constructor(e){c(this,"storageKey");this.storageKey=e;}getToggle(e){return this.getSetting(e)==="true"}getSetting(e){return localStorage.getItem(`${this.storageKey}-${e}`)}setSetting(e,t){localStorage.setItem(`${this.storageKey}-${e}`,t);}getJSON(e){const t=this.getSetting(e);return t===null?null:JSON.parse(t)}setJSON(e,t){this.setSetting(e,JSON.stringify(t));}}const o=new b("kwack.mavri.tsc.rocks");function h(n,e){return new Promise((t,r)=>{let i;if(document.querySelectorAll(n).length)return t(document.querySelector(n));const s=new MutationObserver(()=>{if(document.querySelectorAll(n).length)return s.disconnect(),i!=null&&clearTimeout(i),t(document.querySelector(n))});s.observe(document.body,{childList:!0,subtree:!0}),e&&(i=setTimeout(()=>{s.disconnect(),t(null);},e));})}function w(n,e){const t=o.getJSON(`spy-${n}`);return t?Promise.resolve(t):new Promise((r,i)=>{(GM.xmlHttpRequest??GM.xmlhttpRequest)({method:"POST",url:"https://tsc.diicot.cc/stats/update",headers:{authorization:"10000000-6000-0000-0009-000000000001","x-requested-with":"XMLHttpRequest","Content-Type":"application/json"},data:JSON.stringify({apiKey:e,userId:n}),onload(m){const l=JSON.parse(m.responseText);console.log(l),!("error"in l)&&l.success&&o.setJSON(`spy-${n}`,l),r(l);},onerror(){i({success:!1,code:999});},timeout:5e3});})}function u(n){return Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:2,minimumFractionDigits:2}).format(n)}const C=new g({name:"Profile Page",description:"Shows a user's spy on their profile page",shouldRun:async function(){return o.getToggle(this.name)&&window.location.pathname==="/profiles.php"},start:async()=>{const n=await h(".empty-block",15e3);if(n===null){a.warn("Could not find the empty block on the profile page");return}const e=window.location.search.split("XID=")[1],t=o.getSetting("api-key");if(!t){a.warn("No API key found, cannot fetch spy");return}const r=await w(e,t);if("error"in r){a.error(r.message);return}if(!r.success){a.error(`Failed to fetch spy: ${r.code}`);return}const{estimate:i,statInterval:s}=r.spy;$(n).append($("<table>").addClass("tsc-stat-table").append($("<tr>").append($("<th>").text("Estimate Stats")).append($("<th>").text("Min")).append($("<th>").text("Max")).append($("<th>").text("Battle Score"))).append($("<tr>").append($("<td>").text(u(BigInt(i.stats)))).append($("<td>").text(s?u(BigInt(s.min)):"N/A")).append($("<td>").text(s?u(BigInt(s.max)):"N/A")).append($("<td>").text(s?s.battleScore:"N/A"))));}}),f=Object.freeze(Object.defineProperty({__proto__:null,ProfilePage:C},Symbol.toStringTag,{value:"Module"})),d=new g({name:"Settings Panel",description:"Adds a settings panel to the factions page.",shouldRun:async function(){return window.location.pathname==="/factions.php"},start:async function(){const n=await h("#factions > ul",15e3);if(n===null){a.warn(`${this.name}: Failed to find element to append to.`);return}const e=Object.values(f);a.debug("Features:",e),$(n).after($("<details>").addClass("tsc-accordion").append($("<summary>").text("TSC Settings")).append($("<p>").css("margin-top","5px").text("This is the settings panel for the Torn Spies Central script."),$("<p>").text("Here you can configure the settings to your liking. Please note that changes will be saved automatically."),$("<br>"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","enable").prop("checked",o.getToggle("enable")).on("change",function(){o.setSetting("enable",$(this).prop("checked")),a.debug(`Set enable to ${$(this).prop("checked")}`);})).append($("<p>").text("Enable Script")),$("<br>"),$("<div>").addClass("tsc-setting-entry").append($("<label>").attr("for","api-key").text("API Key"),$("<input>").attr("type","text").attr("id","api-key").attr("placeholder","Paste your key here...").addClass("tsc-key-input").addClass("tsc-blur").val(o.getSetting("api-key")||"").on("change",function(){const t=$(this).val();if(typeof t!="string"){a.warn("API Key is not a string.");return}if(!/^[a-zA-Z0-9]{16}$/.test(t)){a.warn("API Key is not valid."),$(this).css("outline","1px solid red");return}$(this).css("outline","none"),t!==o.getSetting("api-key")&&(o.setSetting("api-key",t),a.debug(`Set api-key to ${t}`));})),$("<br>"),e.map(t=>$("<div>").append($("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id",t.name).prop("checked",o.getToggle(t.name)).on("change",function(){o.setSetting(t.name,$(this).prop("checked")),a.debug(`Set ${t.name} to ${$(this).prop("checked")}`);})).append($("<p>").text(t.name))).append($("<p>").text(t.description)))));}});async function k(){if(await d.shouldRun()===!0&&(a.info("Settings panel feature started"),await d.start()),o.getToggle("enable")===!1){a.info("TSC is disabled");return}a.info("Starting TSC features...");for(const n of Object.values(f)){if(await n.shouldRun()===!1){a.info(`${n.name} feature not applicable`);continue}try{await n.start(),a.info(`${n.name} feature started`);}catch(e){a.error(`Failed to start ${n.name} feature:`,e);}}}k().catch(n=>{a.error("TSC failed catastrophically:",n);});

})();