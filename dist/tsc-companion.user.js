// ==UserScript==
// @name         TSC Companion - Next
// @namespace    TSC
// @version      next-14
// @author       mavri [2402357]
// @description  A very early version of the new TSC Companion. Special thanks to Kwack [2190604]
// @copyright    2024, diicot.cc
// @icon         https://i.imgur.com/8eydsOA.png
// @updateURL    https://github.com/LeoMavri/TSC-Companion/raw/next/dist/tsc-companion.user.js
// @match        https://www.torn.com/profiles.php?*
// @match        https://www.torn.com/factions.php*
// @match        https://www.torn.com/joblist.php*
// @connect      api.torn.com
// @connect      tsc.diicot.cc
// @grant        GM.xmlHttpRequest
// @grant        GM_addStyle
// @run-at       document-end
// ==/UserScript==

(o=>{if(typeof GM_addStyle=="function"){GM_addStyle(o);return}const r=document.createElement("style");r.textContent=o,document.head.append(r)})(" body{--tsc-bg-color: #f0f0f0;--tsc-alt-bg-color: #fff;--tsc-border-color: #ccc;--tsc-input-color: #ccc;--tsc-text-color: #000;--tsc-hover-color: #ddd}body.dark-mode{--tsc-bg-color: #333;--tsc-alt-bg-color: #383838;--tsc-border-color: #444;--tsc-input-color: #504f4f;--tsc-text-color: #ccc;--tsc-hover-color: #555}.tsc-loader{content:url(https://www.torn.com/images/v2/main/ajax-loader.gif)}body.dark-mode .tsc-loader{content:url(https://www.torn.com/images/v2/main/ajax-loader-white.gif)}table.tsc-stat-table{width:100%;border-collapse:collapse;color:var(--tsc-text-color);background-color:var(--tsc-bg-color)}table.tsc-stat-table th,table.tsc-stat-table td{border:1px solid var(--tsc-border-color);color:var(--tsc-text-color);padding:4px;text-align:center}table.tsc-stat-table th{background-color:var(--tsc-bg-color);color:var(--tsc-text-color)}.tsc-faction-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;margin-left:auto;margin-right:2px}.tsc-chain-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);font-size:10px;display:flex;vertical-align:middle;justify-content:center;align-items:center;width:200%;height:15px;border-radius:5px;padding:3px;margin-left:2px;cursor:pointer}.respect{margin-left:32px!important}.attack-number{min-width:45px!important}.tsc-company-spy{display:inline;background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;margin-left:5px}.tsc-faction-war{display:flex;background-color:var(--tsc-alt-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);padding:3px;cursor:pointer;height:15px;vertical-align:middle;justify-content:space-around;align-items:center}.tsc-accordion{background-color:var(--tsc-bg-color);border:1px solid var(--tsc-border-color);border-radius:5px;margin:10px 0;padding:10px}.tsc-header{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:1.2em;margin-top:10px;margin-bottom:10px}.tsc-header-username{font-style:italic;display:inline}.tsc-setting-entry{display:flex;align-items:center;gap:5px;margin-top:10px;margin-bottom:5px}.tsc-key-input{width:120px;padding-left:5px;background-color:var(--tsc-input-color);color:var(--tsc-text-color)}.tsc-button{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);transition:background-color .5s;border-radius:5px;padding:5px 10px;cursor:pointer}.tsc-button:hover{background-color:var(--tsc-hover-color);transition:background-color .5s}.tsc-blur{filter:blur(3px);transition:filter 2s}.tsc-blur:focus,.tsc-blur:active{transition-duration:.5s;filter:blur(0)} ");

(function () {
	'use strict';

	var pe=Object.defineProperty;var he=(r,t,e)=>t in r?pe(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var k=(r,t,e)=>(he(r,typeof t!="symbol"?t+"":t,e),e);class ge{constructor(t){k(this,"storageKey");this.storageKey=t;}get(t){return localStorage.getItem(`${this.storageKey}-${t}`)}set(t,e){localStorage.setItem(`${this.storageKey}-${t}`,e);}getToggle(t){return this.get(t)==="true"}getJSON(t){const e=this.get(t);return e===null?null:JSON.parse(e)}setJSON(t,e){this.set(t,JSON.stringify(e));}fullClear(){let t=0;for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e);s!=null&&s.startsWith(this.storageKey)&&(localStorage.removeItem(s),++t);}return t}spyClear(){let t=0;for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e);s!=null&&s.startsWith(`${this.storageKey}-spy`)&&(localStorage.removeItem(s),++t);}return t}}const d=new ge("kwack.mavri.tsc.rocks"),B={Colours:{Info:"#05668D",Warn:"#EDDEA4",Error:"#ff0000",Debug:"#5C415D"}},me="###PDA-APIKEY###",j=me.includes("PDA-APIKEY")===!1;class c{static info(t,...e){let s="%c",n=`color: ${B.Colours.Info}`;j&&(e=e.map(a=>JSON.stringify(a)),s="",n=""),console.info(`${s}[TSC Companion] ${t}`,n,...e);}static warn(t,...e){let s="%c",n=`color: ${B.Colours.Warn}`;j&&(e=e.map(a=>JSON.stringify(a)),s="",n=""),console.log(`${s}[TSC Companion] ${t}`,n,...e);}static error(t,...e){let s="%c",n=`color: ${B.Colours.Error}`;j&&(e=e.map(a=>JSON.stringify(a)),s="",n=""),console.error(`${s}[TSC Companion] ${t}`,n,...e);}static debug(t,...e){if(!d.getToggle("debug-logs"))return;let s="%c",n=`color: ${B.Colours.Debug}`;j&&(e=e.map(a=>JSON.stringify(a)),s="",n=""),console.log(`${s}[TSC Companion] ${t}`,n,...e);}}function ce(r){switch(r){case 1:return "Invalid request";case 2:return "Maintenance";case 3:return "Invalid API Key";case 4:return "Internal Error";case 5:return "User Disabled";case 6:return "Cached Only";case 999:return "Service Down";default:return "Unknown error"}}const le=12*60*60*1e3;function P(r){const t=d.getJSON(`spy-${r}`);if(t){if(t.insertedAt&&new Date().getTime()-new Date(t.insertedAt).getTime()<le)return c.debug("Spy cache still valid"),Promise.resolve(t);c.debug("Spy cache expired, fetching new data"),d.setJSON(`spy-${r}`,null);}return new Promise((e,s)=>{(GM.xmlHttpRequest??GM.xmlhttpRequest)({method:"POST",url:"https://tsc.diicot.cc/next",timeout:3e4,headers:{Authorization:"10000000-6000-0000-0009-000000000001","x-requested-with":"XMLHttpRequest","Content-Type":"application/json"},data:JSON.stringify({apiKey:d.get("tsc-key")??"",userId:r}),onload(a){const o=JSON.parse(a.responseText);!("error"in o)&&o.success&&d.setJSON(`spy-${r}`,{...o,insertedAt:new Date().getTime()}),e(o);},onerror(a){c.debug("Failed to fetch spy: ",a),e({error:!0,message:`Failed to fetch spy: ${a.statusText}`});},onabort(){e({error:!0,message:"Request aborted"});},ontimeout(){e({error:!0,message:"Request timed out"});}});})}async function ye(){if(d.get("tsc-key")===null)return {error:!0,message:"API Key not set"};const r=d.getJSON("user-data");if(r){if(r.insertedAt&&new Date().getTime()-new Date(r.insertedAt).getTime()<le)return c.debug("User data cache still valid"),r;c.debug("User data cache expired, fetching new data"),d.setJSON("user-data",null);}const t=await fetch(`https://api.torn.com/user/?selections=basic&key=${d.get("tsc-key")}&comment=TSC-Next`);if(!t.ok)return {error:!0,message:t.statusText};const e=await t.json();return e.error?{error:!0,message:e.error.error}:(d.setJSON("user-data",{...e,insertedAt:new Date().getTime()}),e)}function D(r,t){return new Promise((e,s)=>{let n;if(document.querySelectorAll(r).length)return e(document.querySelector(r));const a=new MutationObserver(()=>{if(document.querySelectorAll(r).length)return a.disconnect(),n!=null&&clearTimeout(n),e(document.querySelector(r))});a.observe(document.body,{childList:!0,subtree:!0}),t&&(n=setTimeout(()=>{a.disconnect(),e(null);},t));})}function x(r,t=2){return Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:t,minimumFractionDigits:t}).format(r)}function G(r){const{estimate:t,statInterval:e}=r.spy;let s=x(t.stats,1),n=`Estimate: ${x(t.stats,2)}`;return e!=null&&e.battleScore&&(s=`${x(BigInt(e.min),1)} - ${x(BigInt(e.max),1)}`,n+=`<br>Interval: ${x(BigInt(e.min),2)} - ${x(BigInt(e.max),2)}<br>Battle Score: ${x(e.battleScore,2)}`),{spyText:s,tooltipText:n}}function $e(r){const{estimate:t,statInterval:e}=r.spy;let s="",n=`Estimate: ${x(t.stats)}`,a=`Estimate: ${new Date(t.lastUpdated).toLocaleDateString()}`;return e!=null&&e.battleScore&&(s=`${x(BigInt(e.min))} - ${x(BigInt(e.max))} / FF: ${e.fairFight}`,a+=`<br>Interval: ${new Date(e.lastUpdated).toLocaleDateString()}`),{longTextInterval:s,longTextEstimate:n,toolTipText:a}}class F{constructor({name:t,description:e,shouldRun:s,start:n}){k(this,"name");k(this,"description");k(this,"shouldRun");k(this,"start");this.name=t,this.description=e,this.shouldRun=s,this.start=n;}}const be=".empty-block",we=new F({name:"Profile Page",description:"Shows a user's spy on their profile page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.pathname==="/profiles.php"},start:async function(){const r=await D(be,15e3);if(r===null){c.warn(`${this.name}: Could not find the empty block on the profile page`);return}const t=window.location.search.split("XID=")[1];if(!t){c.error(`${this.name}: Could not find the user's ID`);return}$(r).append($("<img>").addClass("tsc-loader")).css({display:"flex","justify-content":"center","align-items":"center"});const e=await P(t);if($(r).empty(),"error"in e||e.success!==!0){c.error(`${this.name}: Failed to fetch spy`,e),"error"in e?$(r).append($("<div>").text(e.message)):$(r).append($("<div>").text(ce(e.code)));return}const{estimate:s,statInterval:n}=e.spy;$(r).append($("<table>").addClass("tsc-stat-table").attr("title",`Inteval: ${n!=null&&n.lastUpdated?new Date(n.lastUpdated).toLocaleString():"N/A"}<br>Estimate: ${new Date(s.lastUpdated).toLocaleString()}<br>Cache: ${new Date(e.insertedAt).toLocaleString()}`).append($("<tr>").append($("<th>").text("Estimated Stats")).append($("<th>").text("Min")).append($("<th>").text("Max")).append($("<th>").text("Battle Score")).append($("<th>").text("Fair Fight"))).append($("<tr>").append($("<td>").text(x(BigInt(s.stats)))).append($("<td>").text(n!=null&&n.battleScore?x(BigInt(n.min)):"N/A")).append($("<td>").text(n!=null&&n.battleScore?x(BigInt(n.max)):"N/A")).append($("<td>").text(n!=null&&n.battleScore?x(n.battleScore):"N/A")).append($("<td>").text(n!=null&&n.battleScore?n.fairFight:"N/A"))));}}),xe=".faction-info-wrap.restyle.another-faction .table-body > li:nth-child(1)",Ee='[class*="userInfoBox"]',Se='a[href^="/profiles.php?XID="]',Te=new F({name:"Faction - Normal",description:"Shows a list of spies on the faction page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.href.includes("factions.php?step=profile")},start:async function(){const r=await D(xe,15e3);if(r===null){c.warn(`${this.name}: Failed to find element to append to.`);return}const t=$(r).parent()[0];$(t).children("li").each((e,s)=>{const n=$(s).find(Ee)[0];//! This is a bit of a hack, but it works for now
	if($(n).css("width","169px"),$(n).css("overflow","hidden"),$(n).css("text-overflow","ellipsis"),n===void 0){c.debug(`${this.name}: Failed to find the player's profile box.`,s);return}const a=$(n).find(Se)[0];if(a===void 0){c.debug(`${this.name}: Failed to find user's ID`,n);return}const o=a.href.split("XID=")[1];P(o).then(u=>{if("error"in u||u.success!==!0){c.warn(`${this.name}: Failed to find spy for ${o}`,u);return}const{spyText:l,tooltipText:g}=G(u);$(n).after($("<div>").addClass("tsc-faction-spy").text(l).attr("title",g));});});}}),q='[class^="warListItem"][class*="first-in-row"]',Z='[class^="chain-attacks-list"]',Ce='[class^="honorWrap"]',ve=new F({name:"Faction - Chain",description:"Shows spies on the chain page",shouldRun:async function(){return !d.getToggle(this.name)||!window.location.href.includes("factions.php?step=your")?!1:await D(q)!==null},start:async function(){let r=null;const t=document.querySelector(q),e=new MutationObserver(async s=>{if(s.length===0)return;const n=document.querySelector(q);if(!(n!=null&&n.classList.contains("act")))return;c.debug(`${this.name}: Chain is active`),r!==null&&(r.disconnect(),r=null);const a=await D(Z,15e3);if(!a){c.debug(`${this.name}: Could not find attacks list (element did not show up in time)`);return}const o=async()=>{$(`${Z} li`).each(function(u,l){const g=$(l).find(Ce);for(let m=0;m<=1;m++){const E=g[m];if($(E).parent().find(".tsc-chain-spy").length>0)continue;const p=$(E).find("a").attr("href");if(!p){c.warn("Faction - Chain: Failed to find ID.");return}const b=p.split("XID=")[1];P(b).then(S=>{if("error"in S||S.success!==!0){c.warn(`Faction - Chain: Failed to find spy for ${b}`,S);return}const{spyText:i,tooltipText:v}=G(S);$(E).append($("<div>").addClass("tsc-chain-spy").text(i).attr("title",v));});}});};r=new MutationObserver(async u=>{let l=!1;$(`${q} li`).each(function(g,m){$(m).find(".tsc-chain-spy").length===0&&l===!1&&(l=!0,o());});}),await o(),r.observe(a,{childList:!0,subtree:!0});});if(!t){c.error(`${this.name}: Could not find element`);return}e.observe(t,{attributes:!0,attributeFilter:["class"]});}}),Oe="#mainContainer > div.content-wrapper.spring > div.employees-wrap > ul",De='a[href^="/profiles.php?XID="]',Re=new F({name:"Company Page",description:"Shows a user spies on the company page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.pathname==="/joblist.php"&&window.location.hash.includes("p=corpinfo")},start:async function(){const r=await D(Oe,15e3);if(r===null){c.warn(`${this.name}: Failed to find element to append to.`);return}c.debug(`${this.name}: Found users`,r),$(r).children("li").each((t,e)=>{const s=$(e).find(De)[0];if(s===void 0){c.debug(`${this.name}: Failed to find user's ID`,e);return}const n=s.href.split("XID=")[1];c.debug(`${this.name}: Found user ID`,n),P(n).then(a=>{if("error"in a||a.success!==!0){c.warn(`${this.name}: Failed to find spy for ${n}`,a);return}const{spyText:o,tooltipText:u}=G(a);$(s).after($("<div>").addClass("tsc-company-spy").text(o).attr("title",u));});});}}),Q=(r,t)=>Array.prototype.slice.call(r,t);let _=null;typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope?_=self:typeof global<"u"?_=global:window&&(_=window);const L=_,J=_.document,ee=["load","loadend","loadstart"],K=["progress","abort","error","timeout"],ue=r=>["returnValue","totalSize","position"].includes(r),X=function(r,t){for(let e in r){if(ue(e))continue;const s=r[e];try{t[e]=s;}catch{}}return t},te=function(r,t,e){const s=n=>function(a){const o={};for(let u in a){if(ue(u))continue;const l=a[u];o[u]=l===t?e:l;}return e.dispatchEvent(n,o)};for(let n of Array.from(r))e._has(n)&&(t[`on${n}`]=s(n));},Ie=function(r){if(J&&J.createEventObject!=null){const t=J.createEventObject();return t.type=r,t}try{return new Event(r)}catch{return {type:r}}},U=function(r){let t={};const e=n=>t[n]||[],s={};return s.addEventListener=function(n,a,o){t[n]=e(n),!(t[n].indexOf(a)>=0)&&(o=o===void 0?t[n].length:o,t[n].splice(o,0,a));},s.removeEventListener=function(n,a){if(n===void 0){t={};return}a===void 0&&(t[n]=[]);const o=e(n).indexOf(a);o!==-1&&e(n).splice(o,1);},s.dispatchEvent=function(){const n=Q(arguments),a=n.shift();r||(n[0]=X(n[0],Ie(a)),Object.defineProperty(n[0],"target",{writable:!1,value:this}));const o=s[`on${a}`];o&&o.apply(s,n);const u=e(a).concat(e("*"));for(let l=0;l<u.length;l++)u[l].apply(s,n);},s._has=n=>!!(t[n]||s[`on${n}`]),r&&(s.listeners=n=>Q(e(n)),s.on=s.addEventListener,s.off=s.removeEventListener,s.fire=s.dispatchEvent,s.once=function(n,a){var o=function(){return s.off(n,o),a.apply(null,arguments)};return s.on(n,o)},s.destroy=()=>t={}),s},de=`\r
`,ke=function(r){return Object.entries(r).map(([s,n])=>`${s.toLowerCase()}: ${n}`).join(de)},Le=function(r,t){const e=r.split(de);t==null&&(t={});for(let s of e)if(/([^:]+):\s*(.+)/.test(s)){const n=RegExp.$1!=null?RegExp.$1.toLowerCase():void 0,a=RegExp.$2;t[n]==null&&(t[n]=a);}return t},Fe=function(r,t){switch(typeof r){case"object":return ke(r);case"string":return Le(r,t)}return []};var W={convert:Fe};const M=U(!0),ne=r=>r===void 0?null:r,N=L.XMLHttpRequest,R=function(){const t=new N,e={};let s=null,n,a,o;var u=0;const l=function(){if(o.status=s||t.status,s!==-1&&(o.statusText=t.statusText),s!==-1){const f=W.convert(t.getAllResponseHeaders());for(let h in f){const y=f[h];if(!o.headers[h]){const w=h.toLowerCase();o.headers[w]=y;}}return}},g=function(){if(!t.responseType||t.responseType==="text"){o.text=t.responseText,o.data=t.responseText;try{o.xml=t.responseXML;}catch{}}else t.responseType==="document"?(o.xml=t.responseXML,o.data=t.responseXML):o.data=t.response;"responseURL"in t&&(o.finalUrl=t.responseURL);},m=function(){i.status=o.status,i.statusText=o.statusText;},E=function(){"text"in o&&(i.responseText=o.text),"xml"in o&&(i.responseXML=o.xml),"data"in o&&(i.response=o.data),"finalUrl"in o&&(i.responseURL=o.finalUrl);},p=function(){n||i.dispatchEvent("load",{}),i.dispatchEvent("loadend",{}),n&&(i.readyState=0);},b=function(f){for(;f>u&&u<4;)i.readyState=++u,u===1&&i.dispatchEvent("loadstart",{}),u===2&&m(),u===4&&(m(),E()),i.dispatchEvent("readystatechange",{}),u===4&&(e.async===!1?p():setTimeout(p,0));},S=function(f){if(f!==4){b(f);return}const h=M.listeners("after");var y=function(){if(h.length>0){const w=h.shift();w.length===2?(w(e,o),y()):w.length===3&&e.async?w(e,o,y):y();}else b(4);};y();};var i=U();e.xhr=i,t.onreadystatechange=function(f){try{t.readyState===2&&l();}catch{}t.readyState===4&&(a=!1,l(),g()),S(t.readyState);};const v=function(){n=!0;};i.addEventListener("error",v),i.addEventListener("timeout",v),i.addEventListener("abort",v),i.addEventListener("progress",function(f){u<3?S(3):t.readyState<=3&&i.dispatchEvent("readystatechange",{});}),"withCredentials"in t&&(i.withCredentials=!1),i.status=0;for(let f of Array.from(K.concat(ee)))i[`on${f}`]=null;if(i.open=function(f,h,y,w,H){u=0,n=!1,a=!1,e.headers={},e.headerNames={},e.status=0,e.method=f,e.url=h,e.async=y!==!1,e.user=w,e.pass=H,o={},o.headers={},S(1);},i.send=function(f){let h,y;for(h of ["type","timeout","withCredentials"])y=h==="type"?"responseType":h,y in i&&(e[h]=i[y]);e.body=f;const w=function(){te(K,t,i),i.upload&&te(K.concat(ee),t.upload,i.upload),a=!0,t.open(e.method,e.url,e.async,e.user,e.pass);for(h of ["type","timeout","withCredentials"])y=h==="type"?"responseType":h,h in e&&(t[y]=e[h]);for(let O in e.headers){const I=e.headers[O];O&&t.setRequestHeader(O,I);}t.send(e.body);},H=M.listeners("before");var z=function(){if(!H.length)return w();const O=function(C){if(typeof C=="object"&&(typeof C.status=="number"||typeof o.status=="number")){X(C,o),"data"in C||(C.data=C.response||C.text),S(4);return}z();};O.head=function(C){X(C,o),S(2);},O.progress=function(C){X(C,o),S(3);};const I=H.shift();I.length===1?O(I(e)):I.length===2&&e.async?I(e,O):O();};z();},i.abort=function(){s=-1,a?t.abort():i.dispatchEvent("abort",{});},i.setRequestHeader=function(f,h){const y=f!=null?f.toLowerCase():void 0,w=e.headerNames[y]=e.headerNames[y]||f;e.headers[w]&&(h=e.headers[w]+", "+h),e.headers[w]=h;},i.getResponseHeader=f=>ne(o.headers[f?f.toLowerCase():void 0]),i.getAllResponseHeaders=()=>ne(W.convert(o.headers)),t.overrideMimeType&&(i.overrideMimeType=function(){t.overrideMimeType.apply(t,arguments);}),t.upload){let f=U();i.upload=f,e.upload=f;}return i.UNSENT=0,i.OPENED=1,i.HEADERS_RECEIVED=2,i.LOADING=3,i.DONE=4,i.response="",i.responseText="",i.responseXML=null,i.readyState=0,i.statusText="",i};R.UNSENT=0;R.OPENED=1;R.HEADERS_RECEIVED=2;R.LOADING=3;R.DONE=4;var Y={patch(){N&&(L.XMLHttpRequest=R);},unpatch(){N&&(L.XMLHttpRequest=N);},Native:N,Xhook:R};function Ne(r,t){var e={};for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&t.indexOf(s)<0&&(e[s]=r[s]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(r);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(r,s[n])&&(e[s[n]]=r[s[n]]);return e}function Ae(r,t,e,s){function n(a){return a instanceof e?a:new e(function(o){o(a);})}return new(e||(e=Promise))(function(a,o){function u(m){try{g(s.next(m));}catch(E){o(E);}}function l(m){try{g(s.throw(m));}catch(E){o(E);}}function g(m){m.done?a(m.value):n(m.value).then(u,l);}g((s=s.apply(r,t||[])).next());})}const A=L.fetch;function _e(r){const t=["method","headers","body","mode","credentials","cache","redirect","referrer","referrerPolicy","integrity","keepalive","signal","url"];let e={};return t.forEach(s=>e[s]=r[s]),e}function re(r){return r instanceof Headers?se([...r.entries()]):Array.isArray(r)?se(r):r}function se(r){return r.reduce((t,[e,s])=>(t[e]=s,t),{})}const oe=function(r,t={headers:{}}){let e=Object.assign(Object.assign({},t),{isFetch:!0});if(r instanceof Request){const a=_e(r),o=Object.assign(Object.assign({},re(a.headers)),re(e.headers));e=Object.assign(Object.assign(Object.assign({},a),t),{headers:o,acceptedRequest:!0});}else e.url=r;const s=M.listeners("before"),n=M.listeners("after");return new Promise(function(a,o){let u=a;const l=function(p){if(!n.length)return u(p);const b=n.shift();return b.length===2?(b(e,p),l(p)):b.length===3?b(e,p,l):l(p)},g=function(p){if(p!==void 0){const b=new Response(p.body||p.text,p);a(b),l(b);return}m();},m=function(){if(!s.length){E();return}const p=s.shift();if(p.length===1)return g(p(e));if(p.length===2)return p(e,g)},E=()=>Ae(this,void 0,void 0,function*(){const{url:p,isFetch:b,acceptedRequest:S}=e,i=Ne(e,["url","isFetch","acceptedRequest"]);return r instanceof Request&&i.body instanceof ReadableStream&&(i.body=yield new Response(i.body).text()),A(p,i).then(v=>l(v)).catch(function(v){return u=o,l(v),o(v)})});m();})};var V={patch(){A&&(L.fetch=oe);},unpatch(){A&&(L.fetch=A);},Native:A,Xhook:oe};const T=M;T.EventEmitter=U;T.before=function(r,t){if(r.length<1||r.length>2)throw "invalid hook";return T.on("before",r,t)};T.after=function(r,t){if(r.length<2||r.length>3)throw "invalid hook";return T.on("after",r,t)};T.enable=function(){Y.patch(),V.patch();};T.disable=function(){Y.unpatch(),V.unpatch();};T.XMLHttpRequest=Y.Native;T.fetch=V.Native;T.headers=W.convert;T.enable();const Me='a[href^="/profiles.php?XID="]',Pe='[class*="userInfoBox"]',ae="div.member.icons.left",He=new F({name:"Faction - War",description:"Shows spies on the faction war page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.href.includes("factions.php?step=")},start:async function(){T.after(async(r,t)=>{if(r.url.includes("faction_wars.php?redirect=false&step=getwarusers&")===!1)return;if(!await D(ae,1e4)){c.error(`${this.name}: Could not find users`);return}$(ae).each((s,n)=>{const a=$(n).find(Me)[0];if(!a){c.error(`${this.name}: Could not find the user's Href`);return}const o=a.href.split("XID=")[1];if(!o){c.error(`${this.name}: Could not find the user's ID`);return}if(!$(n).find(Pe)[0]){c.debug(`${this.name}: Could not find member's info box.`);return}const l=$("<div>").addClass("tsc-faction-war");l.append($("<img>").addClass("tsc-loader")),$(n).parent().append(l),P(o).then(g=>{if(l.empty(),"error"in g||g.success!==!0){c.warn(`${this.name}: Failed to find spy for ${o}`,g),"error"in g?$(l).append($("<span>").text(g.message)):$(l).append($("<span>").text(ce(g.code)));return}const{longTextInterval:m,longTextEstimate:E,toolTipText:p}=$e(g);l.attr("title",p).append($("<span>").text(E)),m!==""&&$(l).append($("<span>").text(m)),$(n).parent().append(l);});});});}}),fe=Object.freeze(Object.defineProperty({__proto__:null,CompanyPage:Re,FactionChain:ve,FactionNormal:Te,FactionWar:He,ProfilePage:we},Symbol.toStringTag,{value:"Module"})),Be=".profile-wrapper",je=".settings-menu > .link > a:first-child",ie=new F({name:"Settings Panel",description:"Adds a settings panel to your own profile page.",shouldRun:async function(){var s,n;if(window.location.href.includes("profiles.php?XID=")===!1)return !1;const r=await D(je,15e3);if(r===null)return c.warn(`${this.name}: Failed to find name element.`),!1;const t=(s=window.location.href.match(/XID=(\d+)/))==null?void 0:s[1],e=(n=r.href.match(/XID=(\d+)/))==null?void 0:n[1];return t===null||e===null?(c.warn(`${this.name}: Failed to find page ID or name ID.`),!1):t!==e?(c.warn(`${this.name}: Page ID does not match name ID.`),!1):!0},start:async function(){var s;const r=await D(Be,15e3);if(r===null){c.warn(`${this.name}: Failed to find element to append to.`);return}if((s=r.nextElementSibling)!=null&&s.classList.contains("tsc-accordion")){c.warn(`${this.name}: Element already exists`);return}const t=await ye(),e="error"in t?$("<div>").text("Welcome!"):$("<div>").html(`Hey, ${$("<div>").addClass("tsc-header-username").text(t.name).prop("outerHTML")}!`);$(r).after($("<details>").addClass("tsc-accordion").append($("<summary>").text("TSC Settings")).append($("<div>").addClass("tsc-header").append(e),$("<p>").css("margin-top","5px").text("This is the settings panel for the Torn Spies Central script."),$("<p>").text("Here you can configure the settings to your liking. Please note that changes will be saved automatically."),$("<p>").css("margin-top","5px").text("Note: Currently, the script works best with honor bars turned off. If you have them on, all spies (except on the profile page) will be unreadable. You can manage this in Settings -> General Settings -> Honor Names -> Off"),$("<br>"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","enabled").prop("checked",d.getToggle("enabled")).on("change",function(){d.set("enabled",$(this).prop("checked"));})).append($("<p>").text("Enable Script")),$("<div>").addClass("tsc-setting-entry").append($("<label>").attr("for","api-key").text("API Key"),$("<input>").attr("type","text").attr("id","api-key").attr("placeholder","Paste your key here...").addClass("tsc-key-input").addClass("tsc-blur").val(d.get("tsc-key")||"").on("change",function(){const n=$(this).val();if(typeof n=="string"){if(!/^[a-zA-Z0-9]{16}$/.test(n)){$(this).css("outline","1px solid red");return}$(this).css("outline","none"),n!==d.get("tsc-key")&&d.set("tsc-key",n);}})),$("<br>"),$("<p>").text("Feature toggles:"),Object.values(fe).map(n=>$("<div>").append($("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id",n.name).prop("checked",d.getToggle(n.name)).on("change",function(){d.set(n.name,$(this).prop("checked"));})).append($("<p>").text(n.name))).append($("<p>").text(n.description))),$("<br>"),$("<p>").text("The following buttons require a confirmation before anything is deleted.").css("margin-bottom","10px"),$("<button>").text("Clear cached spies").addClass("tsc-button").css("margin-right","10px").on("click",async function(){if(!confirm("Are you sure you want to clear cached spies?"))return;const a=d.spyClear();c.debug(`Cleared ${a} spies from cache.`);const o=$(this);o.animate({opacity:0},"slow",function(){o.text(`Cleared ${a} spies`);}).animate({opacity:1},"slow"),setTimeout(function(){o.animate({opacity:0},"slow",function(){o.text("Clear cached spies");}).animate({opacity:1},"slow");},3e3);}),$("<button>").text("Clear all cache").addClass("tsc-button").on("click",async function(){if(!confirm("Are you sure you want to clear all cache?"))return;const a=d.fullClear();c.debug(`Cleared ${a} items in cache.`);const o=$(this);o.animate({opacity:0},"slow",function(){o.text(`Cleared ${a} items`);}).animate({opacity:1},"slow"),setTimeout(function(){o.animate({opacity:0},"slow",function(){o.text("Clear all cache");}).animate({opacity:1},"slow");},3e3);}),$("<br>"),$("<br>"),$("<p>").text("Debug settings:"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","debug-logs").prop("checked",d.getToggle("debug-logs")).on("change",function(){d.set("debug-logs",$(this).prop("checked"));})).append($("<p>").text("Extra debug logs"))));}});async function qe(){if(await ie.shouldRun()===!0&&(c.info("Settings panel feature started"),await ie.start()),d.getToggle("enabled")===!1){c.info("TSC is disabled");return}c.info("Starting TSC features...");for(const r of Object.values(fe)){if(await r.shouldRun()===!1){c.debug(`${r.name} feature not applicable`);continue}try{await r.start(),c.info(`${r.name} feature started`);}catch(t){c.error(`Failed to start '${r.name}'`,t);}}}qe().catch(r=>{c.error("TSC failed catastrophically:",r);});

})();