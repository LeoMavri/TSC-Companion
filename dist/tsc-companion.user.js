// ==UserScript==
// @name         TSC Companion - Next
// @namespace    TSC
// @version      next-12
// @author       mavri [2402357]
// @description  A very early version of the new TSC Companion. Special thanks to Kwack [2190604]
// @copyright    2024, diicot.cc
// @icon         https://i.imgur.com/8eydsOA.png
// @updateURL    https://github.com/LeoMavri/TSC-Companion/raw/next/dist/tsc-companion.user.js
// @match        https://www.torn.com/profiles.php?*
// @match        https://www.torn.com/factions.php*
// @match        https://www.torn.com/joblist.php*
// @connect      api.torn.com
// @connect      tsc.diicot.cc
// @grant        GM.xmlHttpRequest
// @grant        GM_addStyle
// @run-at       document-end
// ==/UserScript==

(r=>{if(typeof GM_addStyle=="function"){GM_addStyle(r);return}const o=document.createElement("style");o.textContent=r,document.head.append(o)})(" body{--tsc-bg-color: #f0f0f0;--tsc-border-color: #ccc;--tsc-input-color: #ccc;--tsc-text-color: #000;--tsc-hover-color: #ddd}body.dark-mode{--tsc-bg-color: #333;--tsc-border-color: #444;--tsc-input-color: #504f4f;--tsc-text-color: #ccc;--tsc-hover-color: #555}table.tsc-stat-table{width:100%;border-collapse:collapse;color:var(--tsc-text-color);background-color:var(--tsc-bg-color)}table.tsc-stat-table th,table.tsc-stat-table td{border:1px solid var(--tsc-border-color);color:var(--tsc-text-color);padding:4px;text-align:center}table.tsc-stat-table th{background-color:var(--tsc-bg-color);color:var(--tsc-text-color)}.tsc-faction-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;margin-left:auto;margin-right:2px}.tsc-chain-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);font-size:10px;display:flex;vertical-align:middle;justify-content:center;align-items:center;width:200%;height:15px;border-radius:5px;padding:3px;margin-left:2px;cursor:pointer}.respect{margin-left:32px!important}.attack-number{min-width:45px!important}.tsc-company-spy{display:inline;background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;margin-left:5px}.tsc-faction-war{display:flex;background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;height:15px;margin-left:auto;margin-right:9px;vertical-align:middle;justify-content:center;align-items:center}.tsc-faction-rw{display:flex;background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;height:15px;font-size:10px;margin-left:5px;margin-right:9px;vertical-align:middle;justify-content:center;align-items:center}.tsc-accordion{background-color:var(--tsc-bg-color);border:1px solid var(--tsc-border-color);border-radius:5px;margin:10px 0;padding:10px}.tsc-header{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:1.2em;margin-top:10px;margin-bottom:10px}.tsc-header-username{font-style:italic;display:inline}.tsc-setting-entry{display:flex;align-items:center;gap:5px;margin-top:10px;margin-bottom:5px}.tsc-key-input{width:120px;padding-left:5px;background-color:var(--tsc-input-color);color:var(--tsc-text-color)}.tsc-button{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);transition:background-color .5s;border-radius:5px;padding:5px 10px;cursor:pointer}.tsc-button:hover{background-color:var(--tsc-hover-color);transition:background-color .5s}.tsc-blur{filter:blur(3px);transition:filter 2s}.tsc-blur:focus,.tsc-blur:active{transition-duration:.5s;filter:blur(0)} ");

(function () {
	'use strict';

	var de=Object.defineProperty;var fe=(o,t,e)=>t in o?de(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var L=(o,t,e)=>(fe(o,typeof t!="symbol"?t+"":t,e),e);class pe{constructor(t){L(this,"storageKey");this.storageKey=t;}get(t){return localStorage.getItem(`${this.storageKey}-${t}`)}set(t,e){localStorage.setItem(`${this.storageKey}-${t}`,e);}getToggle(t){return this.get(t)==="true"}getJSON(t){const e=this.get(t);return e===null?null:JSON.parse(e)}setJSON(t,e){this.set(t,JSON.stringify(e));}fullClear(){let t=0;for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e);s!=null&&s.startsWith(this.storageKey)&&(localStorage.removeItem(s),++t);}return t}spyClear(){let t=0;for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e);s!=null&&s.startsWith(`${this.storageKey}-spy`)&&(localStorage.removeItem(s),++t);}return t}}const d=new pe("kwack.mavri.tsc.rocks"),j={Colours:{Info:"#05668D",Warn:"#EDDEA4",Error:"#ff0000",Debug:"#5C415D"}},he="###PDA-APIKEY###",q=he.includes("PDA-APIKEY")===!1;class c{static info(t,...e){let s="%c",n=`color: ${j.Colours.Info}`;q&&(e=e.map(i=>JSON.stringify(i)),s="",n=""),console.info(`${s}[TSC Companion] ${t}`,n,...e);}static warn(t,...e){let s="%c",n=`color: ${j.Colours.Warn}`;q&&(e=e.map(i=>JSON.stringify(i)),s="",n=""),console.log(`${s}[TSC Companion] ${t}`,n,...e);}static error(t,...e){let s="%c",n=`color: ${j.Colours.Error}`;q&&(e=e.map(i=>JSON.stringify(i)),s="",n=""),console.error(`${s}[TSC Companion] ${t}`,n,...e);}static debug(t,...e){if(!d.getToggle("debug-logs"))return;let s="%c",n=`color: ${j.Colours.Debug}`;q&&(e=e.map(i=>JSON.stringify(i)),s="",n=""),console.log(`${s}[TSC Companion] ${t}`,n,...e);}}const ae=12*60*60*1e3;function M(o){const t=d.getJSON(`spy-${o}`);if(t){if(t.insertedAt&&new Date().getTime()-new Date(t.insertedAt).getTime()<ae)return c.debug("Spy cache still valid"),Promise.resolve(t);c.debug("Spy cache expired, fetching new data"),d.setJSON(`spy-${o}`,null);}return new Promise((e,s)=>{(GM.xmlHttpRequest??GM.xmlhttpRequest)({method:"POST",url:"https://tsc.diicot.cc/stats/update",timeout:15e3,headers:{authorization:"10000000-6000-0000-0009-000000000001","x-requested-with":"XMLHttpRequest","Content-Type":"application/json"},data:JSON.stringify({apiKey:d.get("tsc-key")??"",userId:o}),onload(i){const r=JSON.parse(i.responseText);!("error"in r)&&r.success&&d.setJSON(`spy-${o}`,{...r,insertedAt:new Date().getTime()}),e(r);},onerror(i){e({error:!0,message:`Failed to fetch spy: ${i.statusText}`});},onabort(){e({error:!0,message:"Request aborted"});},ontimeout(){e({error:!0,message:"Request timed out"});}});})}async function ge(){if(d.get("tsc-key")===null)return {error:!0,message:"API Key not set"};const o=d.getJSON("user-data");if(o){if(o.insertedAt&&new Date().getTime()-new Date(o.insertedAt).getTime()<ae)return c.debug("User data cache still valid"),o;c.debug("User data cache expired, fetching new data"),d.setJSON("user-data",null);}const t=await fetch(`https://api.torn.com/user/?selections=basic&key=${d.get("tsc-key")}&comment=TSC-Next`);if(!t.ok)return {error:!0,message:t.statusText};const e=await t.json();return e.error?{error:!0,message:e.error.error}:(d.setJSON("user-data",{...e,insertedAt:new Date().getTime()}),e)}function k(o,t){return new Promise((e,s)=>{let n;if(document.querySelectorAll(o).length)return e(document.querySelector(o));const i=new MutationObserver(()=>{if(document.querySelectorAll(o).length)return i.disconnect(),n!=null&&clearTimeout(n),e(document.querySelector(o))});i.observe(document.body,{childList:!0,subtree:!0}),t&&(n=setTimeout(()=>{i.disconnect(),e(null);},t));})}function C(o,t=2){return Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:t,minimumFractionDigits:t}).format(o)}function U(o){const{estimate:t,statInterval:e}=o.spy;let s=C(t.stats,1),n=`Estimate: ${C(t.stats,2)}`;return e!=null&&e.battleScore&&(s=`${C(BigInt(e.min),1)} - ${C(BigInt(e.max),1)}`,n+=`<br>Interval: ${C(BigInt(e.min),2)} - ${C(BigInt(e.max),2)}<br>Battle Score: ${C(e.battleScore,2)}`),{spyText:s,tooltipText:n}}class A{constructor({name:t,description:e,shouldRun:s,start:n}){L(this,"name");L(this,"description");L(this,"shouldRun");L(this,"start");this.name=t,this.description=e,this.shouldRun=s,this.start=n;}}const me=".empty-block",ye=new A({name:"Profile Page",description:"Shows a user's spy on their profile page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.pathname==="/profiles.php"},start:async function(){const o=await k(me,15e3);if(o===null){c.warn(`${this.name}: Could not find the empty block on the profile page`);return}const t=window.location.search.split("XID=")[1],e=await M(t);if("error"in e||e.success!==!0){c.error(`${this.name}: Failed to fetch spy`,e);return}const{estimate:s,statInterval:n}=e.spy;$(o).append($("<table>").addClass("tsc-stat-table").attr("title",`Inteval: ${n!=null&&n.lastUpdated?new Date(n.lastUpdated).toLocaleString():"N/A"}<br>Estimate: ${new Date(s.lastUpdated).toLocaleString()}<br>Cache: ${new Date(e.insertedAt).toLocaleString()}`).append($("<tr>").append($("<th>").text("Estimated Stats")).append($("<th>").text("Min")).append($("<th>").text("Max")).append($("<th>").text("Battle Score")).append($("<th>").text("Fair Fight"))).append($("<tr>").append($("<td>").text(C(BigInt(s.stats)))).append($("<td>").text(n!=null&&n.battleScore?C(BigInt(n.min)):"N/A")).append($("<td>").text(n!=null&&n.battleScore?C(BigInt(n.max)):"N/A")).append($("<td>").text(n!=null&&n.battleScore?C(n.battleScore):"N/A")).append($("<td>").text(n!=null&&n.battleScore?n.fairFight:"N/A"))));}}),$e=".faction-info-wrap.restyle.another-faction .table-body > li:nth-child(1)",be='[class*="userInfoBox"]',we='a[href^="/profiles.php?XID="]',xe=new A({name:"Faction - Normal",description:"Shows a list of spies on the faction page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.href.includes("factions.php?step=profile")},start:async function(){const o=await k($e,15e3);if(o===null){c.warn(`${this.name}: Failed to find element to append to.`);return}const t=$(o).parent()[0];$(t).children("li").each((e,s)=>{const n=$(s).find(be)[0];//! This is a bit of a hack, but it works for now
	if($(n).css("width","169px"),$(n).css("overflow","hidden"),$(n).css("text-overflow","ellipsis"),n===void 0){c.debug(`${this.name}: Failed to find the player's profile box.`,s);return}const i=$(n).find(we)[0];if(i===void 0){c.debug(`${this.name}: Failed to find user's ID`,n);return}const r=i.href.split("XID=")[1];M(r).then(l=>{if("error"in l||l.success!==!0){c.warn(`${this.name}: Failed to find spy for ${r}`,l);return}const{spyText:u,tooltipText:y}=U(l);$(n).after($("<div>").addClass("tsc-faction-spy").text(u).attr("title",y));});});}}),B='[class^="warListItem"][class*="first-in-row"]',Z='[class^="chain-attacks-list"]',Se='[class^="honorWrap"]',Ee=new A({name:"Faction - Chain",description:"Shows spies on the chain page",shouldRun:async function(){return !d.getToggle(this.name)||!window.location.href.includes("factions.php?step=your")?!1:await k(B)!==null},start:async function(){let o=null;const t=document.querySelector(B),e=new MutationObserver(async s=>{if(s.length===0)return;const n=document.querySelector(B);if(!(n!=null&&n.classList.contains("act")))return;c.debug(`${this.name}: Chain is active`),o!==null&&(o.disconnect(),o=null);const i=await k(Z,15e3);if(!i){c.debug(`${this.name}: Could not find attacks list (element did not show up in time)`);return}const r=async()=>{$(`${Z} li`).each(function(l,u){const y=$(u).find(Se);for(let g=0;g<=1;g++){const b=y[g];if($(b).parent().find(".tsc-chain-spy").length>0)continue;const p=$(b).find("a").attr("href");if(!p){c.warn("Faction - Chain: Failed to find ID.");return}const w=p.split("XID=")[1];M(w).then(S=>{if("error"in S||S.success!==!0){c.warn(`Faction - Chain: Failed to find spy for ${w}`,S);return}const{spyText:a,tooltipText:v}=U(S);$(b).append($("<div>").addClass("tsc-chain-spy").text(a).attr("title",v));});}});};o=new MutationObserver(async l=>{let u=!1;$(`${B} li`).each(function(y,g){$(g).find(".tsc-chain-spy").length===0&&u===!1&&(u=!0,r());});}),await r(),o.observe(i,{childList:!0,subtree:!0});});if(!t){c.error(`${this.name}: Could not find element`);return}e.observe(t,{attributes:!0,attributeFilter:["class"]});}}),Te="#mainContainer > div.content-wrapper.spring > div.employees-wrap > ul",Ce='a[href^="/profiles.php?XID="]',ve=new A({name:"Company Page",description:"Shows a user spies on the company page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.pathname==="/joblist.php"&&window.location.hash.includes("p=corpinfo")},start:async function(){const o=await k(Te,15e3);if(o===null){c.warn(`${this.name}: Failed to find element to append to.`);return}c.debug(`${this.name}: Found users`,o),$(o).children("li").each((t,e)=>{const s=$(e).find(Ce)[0];if(s===void 0){c.debug(`${this.name}: Failed to find user's ID`,e);return}const n=s.href.split("XID=")[1];c.debug(`${this.name}: Found user ID`,n),M(n).then(i=>{if("error"in i||i.success!==!0){c.warn(`${this.name}: Failed to find spy for ${n}`,i);return}const{spyText:r,tooltipText:l}=U(i);$(s).after($("<div>").addClass("tsc-company-spy").text(r).attr("title",l));});});}}),Q=(o,t)=>Array.prototype.slice.call(o,t);let I=null;typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope?I=self:typeof global<"u"?I=global:window&&(I=window);const N=I,K=I.document,ee=["load","loadend","loadstart"],W=["progress","abort","error","timeout"],ce=o=>["returnValue","totalSize","position"].includes(o),X=function(o,t){for(let e in o){if(ce(e))continue;const s=o[e];try{t[e]=s;}catch{}}return t},te=function(o,t,e){const s=n=>function(i){const r={};for(let l in i){if(ce(l))continue;const u=i[l];r[l]=u===t?e:u;}return e.dispatchEvent(n,r)};for(let n of Array.from(o))e._has(n)&&(t[`on${n}`]=s(n));},Oe=function(o){if(K&&K.createEventObject!=null){const t=K.createEventObject();return t.type=o,t}try{return new Event(o)}catch{return {type:o}}},J=function(o){let t={};const e=n=>t[n]||[],s={};return s.addEventListener=function(n,i,r){t[n]=e(n),!(t[n].indexOf(i)>=0)&&(r=r===void 0?t[n].length:r,t[n].splice(r,0,i));},s.removeEventListener=function(n,i){if(n===void 0){t={};return}i===void 0&&(t[n]=[]);const r=e(n).indexOf(i);r!==-1&&e(n).splice(r,1);},s.dispatchEvent=function(){const n=Q(arguments),i=n.shift();o||(n[0]=X(n[0],Oe(i)),Object.defineProperty(n[0],"target",{writable:!1,value:this}));const r=s[`on${i}`];r&&r.apply(s,n);const l=e(i).concat(e("*"));for(let u=0;u<l.length;u++)l[u].apply(s,n);},s._has=n=>!!(t[n]||s[`on${n}`]),o&&(s.listeners=n=>Q(e(n)),s.on=s.addEventListener,s.off=s.removeEventListener,s.fire=s.dispatchEvent,s.once=function(n,i){var r=function(){return s.off(n,r),i.apply(null,arguments)};return s.on(n,r)},s.destroy=()=>t={}),s},le=`\r
`,ke=function(o){return Object.entries(o).map(([s,n])=>`${s.toLowerCase()}: ${n}`).join(le)},Re=function(o,t){const e=o.split(le);t==null&&(t={});for(let s of e)if(/([^:]+):\s*(.+)/.test(s)){const n=RegExp.$1!=null?RegExp.$1.toLowerCase():void 0,i=RegExp.$2;t[n]==null&&(t[n]=i);}return t},De=function(o,t){switch(typeof o){case"object":return ke(o);case"string":return Re(o,t)}return []};var G={convert:De};const H=J(!0),ne=o=>o===void 0?null:o,F=N.XMLHttpRequest,R=function(){const t=new F,e={};let s=null,n,i,r;var l=0;const u=function(){if(r.status=s||t.status,s!==-1&&(r.statusText=t.statusText),s!==-1){const f=G.convert(t.getAllResponseHeaders());for(let h in f){const m=f[h];if(!r.headers[h]){const x=h.toLowerCase();r.headers[x]=m;}}return}},y=function(){if(!t.responseType||t.responseType==="text"){r.text=t.responseText,r.data=t.responseText;try{r.xml=t.responseXML;}catch{}}else t.responseType==="document"?(r.xml=t.responseXML,r.data=t.responseXML):r.data=t.response;"responseURL"in t&&(r.finalUrl=t.responseURL);},g=function(){a.status=r.status,a.statusText=r.statusText;},b=function(){"text"in r&&(a.responseText=r.text),"xml"in r&&(a.responseXML=r.xml),"data"in r&&(a.response=r.data),"finalUrl"in r&&(a.responseURL=r.finalUrl);},p=function(){n||a.dispatchEvent("load",{}),a.dispatchEvent("loadend",{}),n&&(a.readyState=0);},w=function(f){for(;f>l&&l<4;)a.readyState=++l,l===1&&a.dispatchEvent("loadstart",{}),l===2&&g(),l===4&&(g(),b()),a.dispatchEvent("readystatechange",{}),l===4&&(e.async===!1?p():setTimeout(p,0));},S=function(f){if(f!==4){w(f);return}const h=H.listeners("after");var m=function(){if(h.length>0){const x=h.shift();x.length===2?(x(e,r),m()):x.length===3&&e.async?x(e,r,m):m();}else w(4);};m();};var a=J();e.xhr=a,t.onreadystatechange=function(f){try{t.readyState===2&&u();}catch{}t.readyState===4&&(i=!1,u(),y()),S(t.readyState);};const v=function(){n=!0;};a.addEventListener("error",v),a.addEventListener("timeout",v),a.addEventListener("abort",v),a.addEventListener("progress",function(f){l<3?S(3):t.readyState<=3&&a.dispatchEvent("readystatechange",{});}),"withCredentials"in t&&(a.withCredentials=!1),a.status=0;for(let f of Array.from(W.concat(ee)))a[`on${f}`]=null;if(a.open=function(f,h,m,x,P){l=0,n=!1,i=!1,e.headers={},e.headerNames={},e.status=0,e.method=f,e.url=h,e.async=m!==!1,e.user=x,e.pass=P,r={},r.headers={},S(1);},a.send=function(f){let h,m;for(h of ["type","timeout","withCredentials"])m=h==="type"?"responseType":h,m in a&&(e[h]=a[m]);e.body=f;const x=function(){te(W,t,a),a.upload&&te(W.concat(ee),t.upload,a.upload),i=!0,t.open(e.method,e.url,e.async,e.user,e.pass);for(h of ["type","timeout","withCredentials"])m=h==="type"?"responseType":h,h in e&&(t[m]=e[h]);for(let O in e.headers){const D=e.headers[O];O&&t.setRequestHeader(O,D);}t.send(e.body);},P=H.listeners("before");var z=function(){if(!P.length)return x();const O=function(T){if(typeof T=="object"&&(typeof T.status=="number"||typeof r.status=="number")){X(T,r),"data"in T||(T.data=T.response||T.text),S(4);return}z();};O.head=function(T){X(T,r),S(2);},O.progress=function(T){X(T,r),S(3);};const D=P.shift();D.length===1?O(D(e)):D.length===2&&e.async?D(e,O):O();};z();},a.abort=function(){s=-1,i?t.abort():a.dispatchEvent("abort",{});},a.setRequestHeader=function(f,h){const m=f!=null?f.toLowerCase():void 0,x=e.headerNames[m]=e.headerNames[m]||f;e.headers[x]&&(h=e.headers[x]+", "+h),e.headers[x]=h;},a.getResponseHeader=f=>ne(r.headers[f?f.toLowerCase():void 0]),a.getAllResponseHeaders=()=>ne(G.convert(r.headers)),t.overrideMimeType&&(a.overrideMimeType=function(){t.overrideMimeType.apply(t,arguments);}),t.upload){let f=J();a.upload=f,e.upload=f;}return a.UNSENT=0,a.OPENED=1,a.HEADERS_RECEIVED=2,a.LOADING=3,a.DONE=4,a.response="",a.responseText="",a.responseXML=null,a.readyState=0,a.statusText="",a};R.UNSENT=0;R.OPENED=1;R.HEADERS_RECEIVED=2;R.LOADING=3;R.DONE=4;var V={patch(){F&&(N.XMLHttpRequest=R);},unpatch(){F&&(N.XMLHttpRequest=F);},Native:F,Xhook:R};function Le(o,t){var e={};for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&t.indexOf(s)<0&&(e[s]=o[s]);if(o!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(o);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(o,s[n])&&(e[s[n]]=o[s[n]]);return e}function Ne(o,t,e,s){function n(i){return i instanceof e?i:new e(function(r){r(i);})}return new(e||(e=Promise))(function(i,r){function l(g){try{y(s.next(g));}catch(b){r(b);}}function u(g){try{y(s.throw(g));}catch(b){r(b);}}function y(g){g.done?i(g.value):n(g.value).then(l,u);}y((s=s.apply(o,t||[])).next());})}const _=N.fetch;function Ae(o){const t=["method","headers","body","mode","credentials","cache","redirect","referrer","referrerPolicy","integrity","keepalive","signal","url"];let e={};return t.forEach(s=>e[s]=o[s]),e}function oe(o){return o instanceof Headers?se([...o.entries()]):Array.isArray(o)?se(o):o}function se(o){return o.reduce((t,[e,s])=>(t[e]=s,t),{})}const re=function(o,t={headers:{}}){let e=Object.assign(Object.assign({},t),{isFetch:!0});if(o instanceof Request){const i=Ae(o),r=Object.assign(Object.assign({},oe(i.headers)),oe(e.headers));e=Object.assign(Object.assign(Object.assign({},i),t),{headers:r,acceptedRequest:!0});}else e.url=o;const s=H.listeners("before"),n=H.listeners("after");return new Promise(function(i,r){let l=i;const u=function(p){if(!n.length)return l(p);const w=n.shift();return w.length===2?(w(e,p),u(p)):w.length===3?w(e,p,u):u(p)},y=function(p){if(p!==void 0){const w=new Response(p.body||p.text,p);i(w),u(w);return}g();},g=function(){if(!s.length){b();return}const p=s.shift();if(p.length===1)return y(p(e));if(p.length===2)return p(e,y)},b=()=>Ne(this,void 0,void 0,function*(){const{url:p,isFetch:w,acceptedRequest:S}=e,a=Le(e,["url","isFetch","acceptedRequest"]);return o instanceof Request&&a.body instanceof ReadableStream&&(a.body=yield new Response(a.body).text()),_(p,a).then(v=>u(v)).catch(function(v){return l=r,u(v),r(v)})});g();})};var Y={patch(){_&&(N.fetch=re);},unpatch(){_&&(N.fetch=_);},Native:_,Xhook:re};const E=H;E.EventEmitter=J;E.before=function(o,t){if(o.length<1||o.length>2)throw "invalid hook";return E.on("before",o,t)};E.after=function(o,t){if(o.length<2||o.length>3)throw "invalid hook";return E.on("after",o,t)};E.enable=function(){V.patch(),Y.patch();};E.disable=function(){V.unpatch(),Y.unpatch();};E.XMLHttpRequest=V.Native;E.fetch=Y.Native;E.headers=G.convert;E.enable();const Fe='a[href^="/profiles.php?XID="]',_e='[class*="userInfoBox"]',Ie=new A({name:"Faction - War",description:"Shows spies on the faction war page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.href.includes("factions.php?step=")},start:async function(){E.after(async(o,t)=>{if(o.url.includes("faction_wars.php?redirect=false&step=getwarusers&")){if(!await k("div.member.icons.left",1e4)){c.error(`${this.name}: Could not find users`);return}$("div.member.icons.left").each((s,n)=>{c.debug("element",n);const i=$(n).find(Fe)[0];if(!i){c.error(`${this.name}: Could not find the user's Href`);return}const r=i.href.split("XID=")[1];if(!r){c.error(`${this.name}: Could not find the user's ID`);return}const l=$(n).find(_e)[0];if(!l){c.debug(`${this.name}: Could not find member's info box.`);return}M(r).then(u=>{if("error"in u||u.success!==!0){c.warn(`${this.name}: Failed to find spy for ${r}`,u);return}const{spyText:y,tooltipText:g}=U(u),b=$("<div>").text(y).attr("title",g);window.location.href.includes("war/rank")?b.addClass("tsc-faction-rw"):b.addClass("tsc-faction-war"),$(l).append(b);});});}});}}),ue=Object.freeze(Object.defineProperty({__proto__:null,CompanyPage:ve,FactionChain:Ee,FactionNormal:xe,FactionWar:Ie,ProfilePage:ye},Symbol.toStringTag,{value:"Module"})),He="#factions > ul",ie=new A({name:"Settings Panel",description:"Adds a settings panel to your own faction page.",shouldRun:async function(){return window.location.href.includes("factions.php?step=your")},start:async function(){var s;const o=await k(He,15e3);if(o===null){c.warn(`${this.name}: Failed to find element to append to.`);return}if((s=o.nextElementSibling)!=null&&s.classList.contains("tsc-accordion")){c.warn(`${this.name}: Element already exists`);return}const t=await ge(),e="error"in t?$("<div>").text("Welcome!"):$("<div>").html(`Hey, ${$("<div>").addClass("tsc-header-username").text(t.name).prop("outerHTML")}!`);$(o).after($("<details>").addClass("tsc-accordion").append($("<summary>").text("TSC Settings")).append($("<div>").addClass("tsc-header").append(e),$("<p>").css("margin-top","5px").text("This is the settings panel for the Torn Spies Central script."),$("<p>").text("Here you can configure the settings to your liking. Please note that changes will be saved automatically."),$("<p>").css("margin-top","5px").text("Note: Currently, the script works best with honor bars turned off. If you have them on, all spies (except on the profile page) will be unreadable. You can manage this in Settings -> General Settings -> Honor Names -> Off"),$("<br>"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","enabled").prop("checked",d.getToggle("enabled")).on("change",function(){d.set("enabled",$(this).prop("checked"));})).append($("<p>").text("Enable Script")),$("<div>").addClass("tsc-setting-entry").append($("<label>").attr("for","api-key").text("API Key"),$("<input>").attr("type","text").attr("id","api-key").attr("placeholder","Paste your key here...").addClass("tsc-key-input").addClass("tsc-blur").val(d.get("tsc-key")||"").on("change",function(){const n=$(this).val();if(typeof n=="string"){if(!/^[a-zA-Z0-9]{16}$/.test(n)){$(this).css("outline","1px solid red");return}$(this).css("outline","none"),n!==d.get("tsc-key")&&d.set("tsc-key",n);}})),$("<br>"),$("<p>").text("Feature toggles:"),Object.values(ue).map(n=>$("<div>").append($("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id",n.name).prop("checked",d.getToggle(n.name)).on("change",function(){d.set(n.name,$(this).prop("checked"));})).append($("<p>").text(n.name))).append($("<p>").text(n.description))),$("<br>"),$("<p>").text("The following buttons require a confirmation before anything is deleted.").css("margin-bottom","10px"),$("<button>").text("Clear cached spies").addClass("tsc-button").css("margin-right","10px").on("click",async function(){if(!confirm("Are you sure you want to clear cached spies?"))return;const i=d.spyClear();c.debug(`Cleared ${i} spies from cache.`);const r=$(this);r.animate({opacity:0},"slow",function(){r.text(`Cleared ${i} spies`);}).animate({opacity:1},"slow"),setTimeout(function(){r.animate({opacity:0},"slow",function(){r.text("Clear cached spies");}).animate({opacity:1},"slow");},3e3);}),$("<button>").text("Clear all cache").addClass("tsc-button").on("click",async function(){if(!confirm("Are you sure you want to clear all cache?"))return;const i=d.fullClear();c.debug(`Cleared ${i} items in cache.`);const r=$(this);r.animate({opacity:0},"slow",function(){r.text(`Cleared ${i} items`);}).animate({opacity:1},"slow"),setTimeout(function(){r.animate({opacity:0},"slow",function(){r.text("Clear all cache");}).animate({opacity:1},"slow");},3e3);}),$("<br>"),$("<br>"),$("<p>").text("Debug settings:"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","debug-logs").prop("checked",d.getToggle("debug-logs")).on("change",function(){d.set("debug-logs",$(this).prop("checked"));})).append($("<p>").text("Extra debug logs"))));}});async function Me(){if(await ie.shouldRun()===!0&&(c.info("Settings panel feature started"),await ie.start()),d.getToggle("enabled")===!1){c.info("TSC is disabled");return}c.info("Starting TSC features...");for(const o of Object.values(ue)){if(await o.shouldRun()===!1){c.debug(`${o.name} feature not applicable`);continue}try{await o.start(),c.info(`${o.name} feature started`);}catch(t){c.error(`Failed to start '${o.name}'`,t);}}}Me().catch(o=>{c.error("TSC failed catastrophically:",o);});

})();