// ==UserScript==
// @name         TSC Companion - Next
// @namespace    TSC
// @version      next-11
// @author       mavri [2402357]
// @description  A very early version of the new TSC Companion. Special thanks to Kwack [2190604]
// @copyright    2024, diicot.cc
// @icon         https://i.imgur.com/8eydsOA.png
// @updateURL    https://github.com/LeoMavri/TSC-Companion/raw/next/dist/tsc-companion.user.js
// @match        https://www.torn.com/profiles.php?*
// @match        https://www.torn.com/factions.php*
// @match        https://www.torn.com/joblist.php*
// @connect      api.torn.com
// @connect      tsc.diicot.cc
// @grant        GM.xmlHttpRequest
// @grant        GM_addStyle
// @run-at       document-end
// ==/UserScript==

(r=>{if(typeof GM_addStyle=="function"){GM_addStyle(r);return}const o=document.createElement("style");o.textContent=r,document.head.append(o)})(" body{--tsc-bg-color: #f0f0f0;--tsc-border-color: #ccc;--tsc-input-color: #ccc;--tsc-text-color: #000;--tsc-hover-color: #ddd}body.dark-mode{--tsc-bg-color: #333;--tsc-border-color: #444;--tsc-input-color: #504f4f;--tsc-text-color: #ccc;--tsc-hover-color: #555}table.tsc-stat-table{width:100%;border-collapse:collapse;color:var(--tsc-text-color);background-color:var(--tsc-bg-color)}table.tsc-stat-table th,table.tsc-stat-table td{border:1px solid var(--tsc-border-color);color:var(--tsc-text-color);padding:4px;text-align:center}table.tsc-stat-table th{background-color:var(--tsc-bg-color);color:var(--tsc-text-color)}.tsc-faction-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;margin-left:auto;margin-right:2px}.tsc-chain-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);font-size:10px;display:flex;vertical-align:middle;justify-content:center;align-items:center;width:200%;height:15px;border-radius:5px;padding:3px;margin-left:2px;cursor:pointer}.respect{margin-left:32px!important}.attack-number{min-width:45px!important}.tsc-company-spy{display:inline;background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;margin-left:5px}.tsc-faction-war{display:flex;background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;height:15px;margin-left:auto;margin-right:9px;vertical-align:middle;justify-content:center;align-items:center}.tsc-faction-rw{display:flex;background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;height:15px;font-size:10px;margin-left:5px;margin-right:9px;vertical-align:middle;justify-content:center;align-items:center}.tsc-accordion{background-color:var(--tsc-bg-color);border:1px solid var(--tsc-border-color);border-radius:5px;margin:10px 0;padding:10px}.tsc-header{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:1.2em;margin-top:10px;margin-bottom:10px}.tsc-header-username{font-style:italic;display:inline}.tsc-setting-entry{display:flex;align-items:center;gap:5px;margin-top:10px;margin-bottom:5px}.tsc-key-input{width:120px;padding-left:5px;background-color:var(--tsc-input-color);color:var(--tsc-text-color)}.tsc-button{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);transition:background-color .5s;border-radius:5px;padding:5px 10px;cursor:pointer}.tsc-button:hover{background-color:var(--tsc-hover-color);transition:background-color .5s}.tsc-blur{filter:blur(3px);transition:filter 2s}.tsc-blur:focus,.tsc-blur:active{transition-duration:.5s;filter:blur(0)} ");

(function () {
	'use strict';

	var ue=Object.defineProperty;var de=(o,e,t)=>e in o?ue(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var D=(o,e,t)=>(de(o,typeof e!="symbol"?e+"":e,t),t);class fe{constructor(e){D(this,"storageKey");this.storageKey=e;}get(e){return localStorage.getItem(`${this.storageKey}-${e}`)}set(e,t){localStorage.setItem(`${this.storageKey}-${e}`,t);}getToggle(e){return this.get(e)==="true"}getJSON(e){const t=this.get(e);return t===null?null:JSON.parse(t)}setJSON(e,t){this.set(e,JSON.stringify(t));}fullClear(){let e=0;for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);s!=null&&s.startsWith(this.storageKey)&&(localStorage.removeItem(s),++e);}return e}spyClear(){let e=0;for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);s!=null&&s.startsWith(`${this.storageKey}-spy`)&&(localStorage.removeItem(s),++e);}return e}}const d=new fe("kwack.mavri.tsc.rocks"),P={Colours:{Info:"#05668D",Warn:"#EDDEA4",Error:"#ff0000",Debug:"#5C415D"}};class c{static info(e,...t){console.info(`%c[TSC Companion] ${e}`,`color: ${P.Colours.Info}`,...t);}static warn(e,...t){console.log(`%c[TSC Companion] ${e}`,`color: ${P.Colours.Warn}`,...t);}static error(e,...t){console.error(`%c[TSC Companion] ${e}`,`color: ${P.Colours.Error}`,...t);}static debug(e,...t){d.getToggle("debug-logs")&&console.log(`%c[TSC Companion] ${e}`,`color: ${P.Colours.Debug}`,...t);}}const ie=12*60*60*1e3;function H(o){const e=d.getJSON(`spy-${o}`);if(e){if(e.insertedAt&&new Date().getTime()-new Date(e.insertedAt).getTime()<ie)return c.debug("Spy cache still valid"),Promise.resolve(e);c.debug("Spy cache expired, fetching new data"),d.setJSON(`spy-${o}`,null);}return new Promise((t,s)=>{(GM.xmlHttpRequest??GM.xmlhttpRequest)({method:"POST",url:"https://tsc.diicot.cc/stats/update",timeout:15e3,headers:{authorization:"10000000-6000-0000-0009-000000000001","x-requested-with":"XMLHttpRequest","Content-Type":"application/json"},data:JSON.stringify({apiKey:d.get("tsc-key")??"",userId:o}),responseType:"json",onload(i){const r=i.response;!("error"in r)&&r.success&&d.setJSON(`spy-${o}`,{...r,insertedAt:new Date().getTime()}),t(r);},onerror(i){t({error:!0,message:`Failed to fetch spy: ${i.statusText}`});},onabort(){t({error:!0,message:"Request aborted"});},ontimeout(){t({error:!0,message:"Request timed out"});}});})}async function pe(){if(d.get("tsc-key")===null)return {error:!0,message:"API Key not set"};const o=d.getJSON("user-data");if(o){if(o.insertedAt&&new Date().getTime()-new Date(o.insertedAt).getTime()<ie)return c.debug("User data cache still valid"),o;c.debug("User data cache expired, fetching new data"),d.setJSON("user-data",null);}const e=await fetch(`https://api.torn.com/user/?selections=basic&key=${d.get("tsc-key")}&comment=TSC-Next`);if(!e.ok)return {error:!0,message:e.statusText};const t=await e.json();return t.error?{error:!0,message:t.error.error}:(d.setJSON("user-data",{...t,insertedAt:new Date().getTime()}),t)}function k(o,e){return new Promise((t,s)=>{let n;if(document.querySelectorAll(o).length)return t(document.querySelector(o));const i=new MutationObserver(()=>{if(document.querySelectorAll(o).length)return i.disconnect(),n!=null&&clearTimeout(n),t(document.querySelector(o))});i.observe(document.body,{childList:!0,subtree:!0}),e&&(n=setTimeout(()=>{i.disconnect(),t(null);},e));})}function C(o,e=2){return Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:e,minimumFractionDigits:e}).format(o)}function U(o){const{estimate:e,statInterval:t}=o.spy;let s=C(e.stats,1),n=`Estimate: ${C(e.stats,2)}`;return t!=null&&t.battleScore&&(s=`${C(BigInt(t.min),1)} - ${C(BigInt(t.max),1)}`,n+=`<br>Interval: ${C(BigInt(t.min),2)} - ${C(BigInt(t.max),2)}<br>Battle Score: ${C(t.battleScore,2)}`),{spyText:s,tooltipText:n}}class A{constructor({name:e,description:t,shouldRun:s,start:n}){D(this,"name");D(this,"description");D(this,"shouldRun");D(this,"start");this.name=e,this.description=t,this.shouldRun=s,this.start=n;}}const he=".empty-block",ge=new A({name:"Profile Page",description:"Shows a user's spy on their profile page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.pathname==="/profiles.php"},start:async function(){const o=await k(he,15e3);if(o===null){c.warn(`${this.name}: Could not find the empty block on the profile page`);return}const e=window.location.search.split("XID=")[1],t=await H(e);if("error"in t){c.error(`${this.name}: Failed to fetch spy`,t);return}if(t.success!==!0){c.error(`${this.name}: Failed to fetch spy`,t);return}const{estimate:s,statInterval:n}=t.spy;$(o).append($("<table>").addClass("tsc-stat-table").attr("title",`Inteval: ${n!=null&&n.lastUpdated?new Date(n.lastUpdated).toLocaleString():"N/A"}<br>Estimate: ${new Date(s.lastUpdated).toLocaleString()}<br>Cache: ${new Date(t.insertedAt).toLocaleString()}`).append($("<tr>").append($("<th>").text("Estimated Stats")).append($("<th>").text("Min")).append($("<th>").text("Max")).append($("<th>").text("Battle Score")).append($("<th>").text("Fair Fight"))).append($("<tr>").append($("<td>").text(C(BigInt(s.stats)))).append($("<td>").text(n!=null&&n.battleScore?C(BigInt(n.min)):"N/A")).append($("<td>").text(n!=null&&n.battleScore?C(BigInt(n.max)):"N/A")).append($("<td>").text(n!=null&&n.battleScore?C(n.battleScore):"N/A")).append($("<td>").text(n!=null&&n.battleScore?n.fairFight:"N/A"))));}}),me=".faction-info-wrap.restyle.another-faction .table-body > li:nth-child(1)",ye='[class*="userInfoBox"]',be='a[href^="/profiles.php?XID="]',$e=new A({name:"Faction - Normal",description:"Shows a list of spies on the faction page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.href.includes("factions.php?step=profile")},start:async function(){const o=await k(me,15e3);if(o===null){c.warn(`${this.name}: Failed to find element to append to.`);return}const e=$(o).parent()[0];$(e).children("li").each((t,s)=>{const n=$(s).find(ye)[0];//! This is a bit of a hack, but it works for now
	if($(n).css("width","169px"),$(n).css("overflow","hidden"),$(n).css("text-overflow","ellipsis"),n===void 0){c.debug(`${this.name}: Failed to find the player's profile box.`,s);return}const i=$(n).find(be)[0];if(i===void 0){c.debug(`${this.name}: Failed to find user's ID`,n);return}const r=i.href.split("XID=")[1];H(r).then(l=>{if("error"in l||l.success!==!0){c.warn(`${this.name}: Failed to find spy for ${r}`,l);return}const{spyText:u,tooltipText:y}=U(l);$(n).after($("<div>").addClass("tsc-faction-spy").text(u).attr("title",y));});});}}),q='[class^="warListItem"][class*="first-in-row"]',Y='[class^="chain-attacks-list"]',we='[class^="honorWrap"]',xe=new A({name:"Faction - Chain",description:"Shows spies on the chain page",shouldRun:async function(){return !d.getToggle(this.name)||!window.location.href.includes("factions.php?step=your")?!1:await k(q)!==null},start:async function(){let o=null;const e=document.querySelector(q),t=new MutationObserver(async s=>{if(s.length===0)return;const n=document.querySelector(q);if(!(n!=null&&n.classList.contains("act")))return;c.debug(`${this.name}: Chain is active`),o!==null&&(o.disconnect(),o=null);const i=await k(Y,15e3);if(!i){c.debug(`${this.name}: Could not find attacks list (element did not show up in time)`);return}const r=async()=>{$(`${Y} li`).each(function(l,u){const y=$(u).find(we);for(let g=0;g<=1;g++){const b=y[g];if($(b).parent().find(".tsc-chain-spy").length>0)continue;const p=$(b).find("a").attr("href");if(!p){c.warn("Faction - Chain: Failed to find ID.");return}const w=p.split("XID=")[1];H(w).then(S=>{if("error"in S||S.success!==!0){c.warn(`Faction - Chain: Failed to find spy for ${w}`,S);return}const{spyText:a,tooltipText:v}=U(S);$(b).append($("<div>").addClass("tsc-chain-spy").text(a).attr("title",v));});}});};o=new MutationObserver(async l=>{let u=!1;$(`${q} li`).each(function(y,g){$(g).find(".tsc-chain-spy").length===0&&u===!1&&(u=!0,r());});}),await r(),o.observe(i,{childList:!0,subtree:!0});});if(!e){c.error(`${this.name}: Could not find element`);return}t.observe(e,{attributes:!0,attributeFilter:["class"]});}}),Se="#mainContainer > div.content-wrapper.spring > div.employees-wrap > ul",Ee='a[href^="/profiles.php?XID="]',Te=new A({name:"Company Page",description:"Shows a user spies on the company page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.pathname==="/joblist.php"&&window.location.hash.includes("p=corpinfo")},start:async function(){const o=await k(Se,15e3);if(o===null){c.warn(`${this.name}: Failed to find element to append to.`);return}c.debug(`${this.name}: Found users`,o),$(o).children("li").each((e,t)=>{const s=$(t).find(Ee)[0];if(s===void 0){c.debug(`${this.name}: Failed to find user's ID`,t);return}const n=s.href.split("XID=")[1];c.debug(`${this.name}: Found user ID`,n),H(n).then(i=>{if("error"in i||i.success!==!0){c.warn(`${this.name}: Failed to find spy for ${n}`,i);return}const{spyText:r,tooltipText:l}=U(i);$(s).after($("<div>").addClass("tsc-company-spy").text(r).attr("title",l));});});}}),Z=(o,e)=>Array.prototype.slice.call(o,e);let I=null;typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope?I=self:typeof global<"u"?I=global:window&&(I=window);const N=I,K=I.document,Q=["load","loadend","loadstart"],J=["progress","abort","error","timeout"],ae=o=>["returnValue","totalSize","position"].includes(o),B=function(o,e){for(let t in o){if(ae(t))continue;const s=o[t];try{e[t]=s;}catch{}}return e},ee=function(o,e,t){const s=n=>function(i){const r={};for(let l in i){if(ae(l))continue;const u=i[l];r[l]=u===e?t:u;}return t.dispatchEvent(n,r)};for(let n of Array.from(o))t._has(n)&&(e[`on${n}`]=s(n));},Ce=function(o){if(K&&K.createEventObject!=null){const e=K.createEventObject();return e.type=o,e}try{return new Event(o)}catch{return {type:o}}},X=function(o){let e={};const t=n=>e[n]||[],s={};return s.addEventListener=function(n,i,r){e[n]=t(n),!(e[n].indexOf(i)>=0)&&(r=r===void 0?e[n].length:r,e[n].splice(r,0,i));},s.removeEventListener=function(n,i){if(n===void 0){e={};return}i===void 0&&(e[n]=[]);const r=t(n).indexOf(i);r!==-1&&t(n).splice(r,1);},s.dispatchEvent=function(){const n=Z(arguments),i=n.shift();o||(n[0]=B(n[0],Ce(i)),Object.defineProperty(n[0],"target",{writable:!1,value:this}));const r=s[`on${i}`];r&&r.apply(s,n);const l=t(i).concat(t("*"));for(let u=0;u<l.length;u++)l[u].apply(s,n);},s._has=n=>!!(e[n]||s[`on${n}`]),o&&(s.listeners=n=>Z(t(n)),s.on=s.addEventListener,s.off=s.removeEventListener,s.fire=s.dispatchEvent,s.once=function(n,i){var r=function(){return s.off(n,r),i.apply(null,arguments)};return s.on(n,r)},s.destroy=()=>e={}),s},ce=`\r
`,ve=function(o){return Object.entries(o).map(([s,n])=>`${s.toLowerCase()}: ${n}`).join(ce)},Oe=function(o,e){const t=o.split(ce);e==null&&(e={});for(let s of t)if(/([^:]+):\s*(.+)/.test(s)){const n=RegExp.$1!=null?RegExp.$1.toLowerCase():void 0,i=RegExp.$2;e[n]==null&&(e[n]=i);}return e},ke=function(o,e){switch(typeof o){case"object":return ve(o);case"string":return Oe(o,e)}return []};var W={convert:ke};const j=X(!0),te=o=>o===void 0?null:o,F=N.XMLHttpRequest,R=function(){const e=new F,t={};let s=null,n,i,r;var l=0;const u=function(){if(r.status=s||e.status,s!==-1&&(r.statusText=e.statusText),s!==-1){const f=W.convert(e.getAllResponseHeaders());for(let h in f){const m=f[h];if(!r.headers[h]){const x=h.toLowerCase();r.headers[x]=m;}}return}},y=function(){if(!e.responseType||e.responseType==="text"){r.text=e.responseText,r.data=e.responseText;try{r.xml=e.responseXML;}catch{}}else e.responseType==="document"?(r.xml=e.responseXML,r.data=e.responseXML):r.data=e.response;"responseURL"in e&&(r.finalUrl=e.responseURL);},g=function(){a.status=r.status,a.statusText=r.statusText;},b=function(){"text"in r&&(a.responseText=r.text),"xml"in r&&(a.responseXML=r.xml),"data"in r&&(a.response=r.data),"finalUrl"in r&&(a.responseURL=r.finalUrl);},p=function(){n||a.dispatchEvent("load",{}),a.dispatchEvent("loadend",{}),n&&(a.readyState=0);},w=function(f){for(;f>l&&l<4;)a.readyState=++l,l===1&&a.dispatchEvent("loadstart",{}),l===2&&g(),l===4&&(g(),b()),a.dispatchEvent("readystatechange",{}),l===4&&(t.async===!1?p():setTimeout(p,0));},S=function(f){if(f!==4){w(f);return}const h=j.listeners("after");var m=function(){if(h.length>0){const x=h.shift();x.length===2?(x(t,r),m()):x.length===3&&t.async?x(t,r,m):m();}else w(4);};m();};var a=X();t.xhr=a,e.onreadystatechange=function(f){try{e.readyState===2&&u();}catch{}e.readyState===4&&(i=!1,u(),y()),S(e.readyState);};const v=function(){n=!0;};a.addEventListener("error",v),a.addEventListener("timeout",v),a.addEventListener("abort",v),a.addEventListener("progress",function(f){l<3?S(3):e.readyState<=3&&a.dispatchEvent("readystatechange",{});}),"withCredentials"in e&&(a.withCredentials=!1),a.status=0;for(let f of Array.from(J.concat(Q)))a[`on${f}`]=null;if(a.open=function(f,h,m,x,M){l=0,n=!1,i=!1,t.headers={},t.headerNames={},t.status=0,t.method=f,t.url=h,t.async=m!==!1,t.user=x,t.pass=M,r={},r.headers={},S(1);},a.send=function(f){let h,m;for(h of ["type","timeout","withCredentials"])m=h==="type"?"responseType":h,m in a&&(t[h]=a[m]);t.body=f;const x=function(){ee(J,e,a),a.upload&&ee(J.concat(Q),e.upload,a.upload),i=!0,e.open(t.method,t.url,t.async,t.user,t.pass);for(h of ["type","timeout","withCredentials"])m=h==="type"?"responseType":h,h in t&&(e[m]=t[h]);for(let O in t.headers){const L=t.headers[O];O&&e.setRequestHeader(O,L);}e.send(t.body);},M=j.listeners("before");var z=function(){if(!M.length)return x();const O=function(T){if(typeof T=="object"&&(typeof T.status=="number"||typeof r.status=="number")){B(T,r),"data"in T||(T.data=T.response||T.text),S(4);return}z();};O.head=function(T){B(T,r),S(2);},O.progress=function(T){B(T,r),S(3);};const L=M.shift();L.length===1?O(L(t)):L.length===2&&t.async?L(t,O):O();};z();},a.abort=function(){s=-1,i?e.abort():a.dispatchEvent("abort",{});},a.setRequestHeader=function(f,h){const m=f!=null?f.toLowerCase():void 0,x=t.headerNames[m]=t.headerNames[m]||f;t.headers[x]&&(h=t.headers[x]+", "+h),t.headers[x]=h;},a.getResponseHeader=f=>te(r.headers[f?f.toLowerCase():void 0]),a.getAllResponseHeaders=()=>te(W.convert(r.headers)),e.overrideMimeType&&(a.overrideMimeType=function(){e.overrideMimeType.apply(e,arguments);}),e.upload){let f=X();a.upload=f,t.upload=f;}return a.UNSENT=0,a.OPENED=1,a.HEADERS_RECEIVED=2,a.LOADING=3,a.DONE=4,a.response="",a.responseText="",a.responseXML=null,a.readyState=0,a.statusText="",a};R.UNSENT=0;R.OPENED=1;R.HEADERS_RECEIVED=2;R.LOADING=3;R.DONE=4;var G={patch(){F&&(N.XMLHttpRequest=R);},unpatch(){F&&(N.XMLHttpRequest=F);},Native:F,Xhook:R};function Re(o,e){var t={};for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&e.indexOf(s)<0&&(t[s]=o[s]);if(o!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(o);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(o,s[n])&&(t[s[n]]=o[s[n]]);return t}function Le(o,e,t,s){function n(i){return i instanceof t?i:new t(function(r){r(i);})}return new(t||(t=Promise))(function(i,r){function l(g){try{y(s.next(g));}catch(b){r(b);}}function u(g){try{y(s.throw(g));}catch(b){r(b);}}function y(g){g.done?i(g.value):n(g.value).then(l,u);}y((s=s.apply(o,e||[])).next());})}const _=N.fetch;function De(o){const e=["method","headers","body","mode","credentials","cache","redirect","referrer","referrerPolicy","integrity","keepalive","signal","url"];let t={};return e.forEach(s=>t[s]=o[s]),t}function ne(o){return o instanceof Headers?oe([...o.entries()]):Array.isArray(o)?oe(o):o}function oe(o){return o.reduce((e,[t,s])=>(e[t]=s,e),{})}const se=function(o,e={headers:{}}){let t=Object.assign(Object.assign({},e),{isFetch:!0});if(o instanceof Request){const i=De(o),r=Object.assign(Object.assign({},ne(i.headers)),ne(t.headers));t=Object.assign(Object.assign(Object.assign({},i),e),{headers:r,acceptedRequest:!0});}else t.url=o;const s=j.listeners("before"),n=j.listeners("after");return new Promise(function(i,r){let l=i;const u=function(p){if(!n.length)return l(p);const w=n.shift();return w.length===2?(w(t,p),u(p)):w.length===3?w(t,p,u):u(p)},y=function(p){if(p!==void 0){const w=new Response(p.body||p.text,p);i(w),u(w);return}g();},g=function(){if(!s.length){b();return}const p=s.shift();if(p.length===1)return y(p(t));if(p.length===2)return p(t,y)},b=()=>Le(this,void 0,void 0,function*(){const{url:p,isFetch:w,acceptedRequest:S}=t,a=Re(t,["url","isFetch","acceptedRequest"]);return o instanceof Request&&a.body instanceof ReadableStream&&(a.body=yield new Response(a.body).text()),_(p,a).then(v=>u(v)).catch(function(v){return l=r,u(v),r(v)})});g();})};var V={patch(){_&&(N.fetch=se);},unpatch(){_&&(N.fetch=_);},Native:_,Xhook:se};const E=j;E.EventEmitter=X;E.before=function(o,e){if(o.length<1||o.length>2)throw "invalid hook";return E.on("before",o,e)};E.after=function(o,e){if(o.length<2||o.length>3)throw "invalid hook";return E.on("after",o,e)};E.enable=function(){G.patch(),V.patch();};E.disable=function(){G.unpatch(),V.unpatch();};E.XMLHttpRequest=G.Native;E.fetch=V.Native;E.headers=W.convert;E.enable();const Ne='a[href^="/profiles.php?XID="]',Ae='[class*="userInfoBox"]',Fe=new A({name:"Faction - War",description:"Shows spies on the faction war page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.href.includes("factions.php?step=")},start:async function(){E.after(async(o,e)=>{if(o.url.includes("faction_wars.php?redirect=false&step=getwarusers&")){if(!await k("div.member.icons.left",1e4)){c.error(`${this.name}: Could not find users`);return}$("div.member.icons.left").each((s,n)=>{c.debug("element",n);const i=$(n).find(Ne)[0];if(!i){c.error(`${this.name}: Could not find the user's Href`);return}const r=i.href.split("XID=")[1];if(!r){c.error(`${this.name}: Could not find the user's ID`);return}const l=$(n).find(Ae)[0];if(!l){c.debug(`${this.name}: Could not find member's info box.`);return}H(r).then(u=>{if("error"in u||u.success!==!0){c.warn(`${this.name}: Failed to find spy for ${r}`,u);return}const{spyText:y,tooltipText:g}=U(u),b=$("<div>").text(y).attr("title",g);window.location.href.includes("war/rank")?b.addClass("tsc-faction-rw"):b.addClass("tsc-faction-war"),$(l).append(b);});});}});}}),le=Object.freeze(Object.defineProperty({__proto__:null,CompanyPage:Te,FactionChain:xe,FactionNormal:$e,FactionWar:Fe,ProfilePage:ge},Symbol.toStringTag,{value:"Module"})),_e="#factions > ul",re=new A({name:"Settings Panel",description:"Adds a settings panel to your own faction page.",shouldRun:async function(){return window.location.href.includes("factions.php?step=your")},start:async function(){var s;const o=await k(_e,15e3);if(o===null){c.warn(`${this.name}: Failed to find element to append to.`);return}if((s=o.nextElementSibling)!=null&&s.classList.contains("tsc-accordion")){c.warn(`${this.name}: Element already exists`);return}const e=await pe(),t="error"in e?$("<div>").text("Welcome!"):$("<div>").html(`Hey, ${$("<div>").addClass("tsc-header-username").text(e.name).prop("outerHTML")}!`);$(o).after($("<details>").addClass("tsc-accordion").append($("<summary>").text("TSC Settings")).append($("<div>").addClass("tsc-header").append(t),$("<p>").css("margin-top","5px").text("This is the settings panel for the Torn Spies Central script."),$("<p>").text("Here you can configure the settings to your liking. Please note that changes will be saved automatically."),$("<p>").css("margin-top","5px").text("Note: Currently, the script works best with honor bars turned off. If you have them on, all spies (except on the profile page) will be unreadable. You can manage this in Settings -> General Settings -> Honor Names -> Off"),$("<br>"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","enabled").prop("checked",d.getToggle("enabled")).on("change",function(){d.set("enabled",$(this).prop("checked"));})).append($("<p>").text("Enable Script")),$("<div>").addClass("tsc-setting-entry").append($("<label>").attr("for","api-key").text("API Key"),$("<input>").attr("type","text").attr("id","api-key").attr("placeholder","Paste your key here...").addClass("tsc-key-input").addClass("tsc-blur").val(d.get("tsc-key")||"").on("change",function(){const n=$(this).val();if(typeof n=="string"){if(!/^[a-zA-Z0-9]{16}$/.test(n)){$(this).css("outline","1px solid red");return}$(this).css("outline","none"),n!==d.get("tsc-key")&&d.set("tsc-key",n);}})),$("<br>"),$("<p>").text("Feature toggles:"),Object.values(le).map(n=>$("<div>").append($("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id",n.name).prop("checked",d.getToggle(n.name)).on("change",function(){d.set(n.name,$(this).prop("checked"));})).append($("<p>").text(n.name))).append($("<p>").text(n.description))),$("<br>"),$("<p>").text("The following buttons require a confirmation before anything is deleted.").css("margin-bottom","10px"),$("<button>").text("Clear cached spies").addClass("tsc-button").css("margin-right","10px").on("click",async function(){if(!confirm("Are you sure you want to clear cached spies?"))return;const i=d.spyClear();c.debug(`Cleared ${i} spies from cache.`);const r=$(this);r.animate({opacity:0},"slow",function(){r.text(`Cleared ${i} spies`);}).animate({opacity:1},"slow"),setTimeout(function(){r.animate({opacity:0},"slow",function(){r.text("Clear cached spies");}).animate({opacity:1},"slow");},3e3);}),$("<button>").text("Clear all cache").addClass("tsc-button").on("click",async function(){if(!confirm("Are you sure you want to clear all cache?"))return;const i=d.fullClear();c.debug(`Cleared ${i} items in cache.`);const r=$(this);r.animate({opacity:0},"slow",function(){r.text(`Cleared ${i} items`);}).animate({opacity:1},"slow"),setTimeout(function(){r.animate({opacity:0},"slow",function(){r.text("Clear all cache");}).animate({opacity:1},"slow");},3e3);}),$("<br>"),$("<br>"),$("<p>").text("Debug settings:"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","debug-logs").prop("checked",d.getToggle("debug-logs")).on("change",function(){d.set("debug-logs",$(this).prop("checked"));})).append($("<p>").text("Extra debug logs"))));}});async function Ie(){if(await re.shouldRun()===!0&&(c.info("Settings panel feature started"),await re.start()),d.getToggle("enabled")===!1){c.info("TSC is disabled");return}c.info("Starting TSC features...");for(const o of Object.values(le)){if(await o.shouldRun()===!1){c.debug(`${o.name} feature not applicable`);continue}try{await o.start(),c.info(`${o.name} feature started`);}catch(e){c.error(`Failed to start '${o.name}'`,e);}}}Ie().catch(o=>{c.error("TSC failed catastrophically:",o);});

})();