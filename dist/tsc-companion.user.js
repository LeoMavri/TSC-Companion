// ==UserScript==
// @name         TSC Companion - Next
// @namespace    TSC
// @version      next-17
// @author       mavri [2402357]
// @description  A very early version of the new TSC Companion. Special thanks to Kwack [2190604]
// @copyright    2024, diicot.cc
// @icon         https://i.imgur.com/8eydsOA.png
// @downloadURL  https://github.com/LeoMavri/TSC-Companion/raw/next/dist/tsc-companion.user.js
// @updateURL    https://github.com/LeoMavri/TSC-Companion/raw/next/dist/tsc-companion.user.js
// @match        https://www.torn.com/profiles.php?*
// @match        https://www.torn.com/factions.php*
// @match        https://www.torn.com/joblist.php*
// @connect      api.torn.com
// @connect      tsc.diicot.cc
// @grant        GM.xmlHttpRequest
// @grant        GM_addStyle
// @run-at       document-end
// ==/UserScript==

(o=>{if(typeof GM_addStyle=="function"){GM_addStyle(o);return}const r=document.createElement("style");r.textContent=o,document.head.append(r)})(" body{--tsc-bg-color: #f0f0f0;--tsc-alt-bg-color: #fff;--tsc-border-color: #ccc;--tsc-input-color: #ccc;--tsc-text-color: #000;--tsc-hover-color: #ddd;--tsc-glow-color: #ffb6c1}body.dark-mode{--tsc-bg-color: #333;--tsc-alt-bg-color: #383838;--tsc-border-color: #444;--tsc-input-color: #504f4f;--tsc-text-color: #ccc;--tsc-hover-color: #555;--tsc-glow-color: #ffb6c1}.tsc-loader{content:url(https://www.torn.com/images/v2/main/ajax-loader.gif)}body.dark-mode .tsc-loader{content:url(https://www.torn.com/images/v2/main/ajax-loader-white.gif)}table.tsc-stat-table{width:100%;border-collapse:collapse;color:var(--tsc-text-color);background-color:var(--tsc-bg-color)}table.tsc-stat-table th,table.tsc-stat-table td{border:1px solid var(--tsc-border-color);color:var(--tsc-text-color);padding:4px;text-align:center}table.tsc-stat-table th{background-color:var(--tsc-bg-color);color:var(--tsc-text-color)}.tsc-faction-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;margin-left:auto;margin-right:2px}.tsc-chain-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);font-size:10px;display:flex;vertical-align:middle;justify-content:center;align-items:center;width:250%;height:15px;border-radius:5px;padding:3px;margin-left:2px;cursor:pointer}.respect{margin-left:32px!important}.attack-number{min-width:45px!important}.tsc-company-spy{display:inline;background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;margin-left:5px}.tsc-faction-war{display:flex;background-color:var(--tsc-alt-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);padding:3px;cursor:pointer;height:15px;vertical-align:middle;justify-content:space-around;align-items:center}.tsc-accordion{background-color:var(--tsc-bg-color);border:1px solid var(--tsc-border-color);border-radius:5px;margin:10px 0;padding:10px}.tsc-header{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:1.2em;margin-top:10px;margin-bottom:10px}.tsc-header-username{font-style:italic;display:inline}.tsc-setting-entry{display:flex;align-items:center;gap:5px;margin-top:10px;margin-bottom:5px}.tsc-key-input{width:120px;padding-left:5px;background-color:var(--tsc-input-color);color:var(--tsc-text-color)}.tsc-button{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);transition:background-color .5s;border-radius:5px;padding:5px 10px;cursor:pointer}.tsc-button:hover{background-color:var(--tsc-hover-color);transition:background-color .5s}.tsc-blur{filter:blur(3px);transition:filter 2s}.tsc-blur:focus,.tsc-blur:active{transition-duration:.5s;filter:blur(0)}.tsc-glow{animation:glow 1s infinite alternate;border-width:3px}@keyframes glow{0%{border-color:var(--tsc-border-color)}to{border-color:var(--tsc-glow-color)}} ");

(function () {
	'use strict';

	var me=Object.defineProperty;var ye=(n,t,e)=>t in n?me(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var I=(n,t,e)=>(ye(n,typeof t!="symbol"?t+"":t,e),e);class $e{constructor(t){I(this,"storageKey");this.storageKey=t;}get(t){return localStorage.getItem(`${this.storageKey}-${t}`)}set(t,e){localStorage.setItem(`${this.storageKey}-${t}`,e);}getToggle(t){return this.get(t)==="true"}getJSON(t){const e=this.get(t);return e===null?null:JSON.parse(e)}setJSON(t,e){this.set(t,JSON.stringify(e));}fullClear(){let t=0;for(let e=0;e<localStorage.length;e++){const o=localStorage.key(e);o!=null&&o.startsWith(this.storageKey)&&(localStorage.removeItem(o),++t);}return t}spyClear(){let t=0;for(let e=0;e<localStorage.length;e++){const o=localStorage.key(e);o!=null&&o.startsWith(`${this.storageKey}-spy`)&&(localStorage.removeItem(o),++t);}return t}}const d=new $e("kwack.mavri.tsc.rocks"),j={Colours:{Info:"#05668D",Warn:"#EDDEA4",Error:"#ff0000",Debug:"#5C415D"}},we="###PDA-APIKEY###",B=we.includes("PDA-APIKEY")===!1;class l{static info(t,...e){let o="%c",r=`color: ${j.Colours.Info}`;B&&(e=e.map(a=>JSON.stringify(a)),o="",r=""),console.info(`${o}[TSC Companion] ${t}`,r,...e);}static warn(t,...e){let o="%c",r=`color: ${j.Colours.Warn}`;B&&(e=e.map(a=>JSON.stringify(a)),o="",r=""),console.log(`${o}[TSC Companion] ${t}`,r,...e);}static error(t,...e){let o="%c",r=`color: ${j.Colours.Error}`;B&&(e=e.map(a=>JSON.stringify(a)),o="",r=""),console.error(`${o}[TSC Companion] ${t}`,r,...e);}static debug(t,...e){if(!d.getToggle("debug-logs"))return;let o="%c",r=`color: ${j.Colours.Debug}`;B&&(e=e.map(a=>JSON.stringify(a)),o="",r=""),console.log(`${o}[TSC Companion] ${t}`,r,...e);}}function ue(n){switch(n){case 1:return "Invalid request";case 2:return "Maintenance";case 3:return "Invalid API Key";case 4:return "Internal Error";case 5:return "User Disabled";case 6:return "Cached Only";case 999:return "Service Down";default:return "Unknown error"}}const de=12*60*60*1e3;function M(n){const t=d.getJSON(`spy-${n}`);if(t){if(t.insertedAt&&new Date().getTime()-new Date(t.insertedAt).getTime()<de)return l.debug("Spy cache still valid"),Promise.resolve(t);l.debug("Spy cache expired, fetching new data"),d.setJSON(`spy-${n}`,null);}const e={apiKey:d.get("tsc-key")??"",userId:n};return new Promise((o,r)=>{(GM.xmlHttpRequest??GM.xmlhttpRequest)({method:"POST",url:"https://tsc.diicot.cc/next",timeout:3e4,headers:{Authorization:"10000000-6000-0000-0009-000000000001","x-requested-with":"XMLHttpRequest","Content-Type":"application/json"},data:JSON.stringify(e),onload(s){const c=JSON.parse(s.responseText);!("error"in c)&&c.success&&d.setJSON(`spy-${n}`,{...c,insertedAt:new Date().getTime()}),o(c);},onerror(s){l.debug("Data used: ",e),o({error:!0,message:`Failed to fetch spy ${s.statusText}`});},onabort(){o({error:!0,message:"Request aborted"});},ontimeout(){o({error:!0,message:"Request timed out"});}});})}async function be(){if(d.get("tsc-key")===null)return {error:!0,message:"API Key not set"};const n=d.getJSON("user-data");if(n){if(n.insertedAt&&new Date().getTime()-new Date(n.insertedAt).getTime()<de)return l.debug("User data cache still valid"),n;l.debug("User data cache expired, fetching new data"),d.setJSON("user-data",null);}const t=await fetch(`https://api.torn.com/user/?selections=basic&key=${d.get("tsc-key")}&comment=TSC-Next`);if(!t.ok)return {error:!0,message:t.statusText};const e=await t.json();return e.error?{error:!0,message:e.error.error}:(d.setJSON("user-data",{...e,insertedAt:new Date().getTime()}),e)}function v(n,t){return new Promise((e,o)=>{let r;if(document.querySelectorAll(n).length)return e(document.querySelector(n));const a=new MutationObserver(()=>{if(document.querySelectorAll(n).length)return a.disconnect(),r!=null&&clearTimeout(r),e(document.querySelector(n))});a.observe(document.body,{childList:!0,subtree:!0}),t&&(r=setTimeout(()=>{a.disconnect(),e(null);},t));})}const xe=".settings-menu > .link > a:first-child";async function fe(){var t;const n=await v(xe,15e3);return n===null?"":((t=n.href.match(/XID=(\d+)/))==null?void 0:t[1])??""}function b(n,t=2){return Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:t,minimumFractionDigits:t}).format(n)}function Y(n){const{estimate:t,statInterval:e}=n.spy;let o=b(t.stats,1),r=`Estimate: ${b(t.stats,2)}`;return e!=null&&e.battleScore&&(o=`${b(BigInt(e.min),1)} - ${b(BigInt(e.max),1)}`,r+=`<br>Interval: ${b(BigInt(e.min),2)} - ${b(BigInt(e.max),2)}<br>Battle Score: ${b(e.battleScore,2)}`),{spyText:o,tooltipText:r}}function Ee(n){const{estimate:t,statInterval:e}=n.spy;let o="",r=`Estimate: ${b(t.stats)}`,a=`Estimate: ${new Date(t.lastUpdated).toLocaleDateString()}`;return e!=null&&e.battleScore&&(o=`${b(BigInt(e.min))} - ${b(BigInt(e.max))} / FF: ${e.fairFight}`,a+=`<br>Interval: ${new Date(e.lastUpdated).toLocaleDateString()}`),{longTextInterval:o,longTextEstimate:r,toolTipText:a}}class F{constructor({name:t,description:e,shouldRun:o,start:r}){I(this,"name");I(this,"description");I(this,"shouldRun");I(this,"start");this.name=t,this.description=e,this.shouldRun=o,this.start=r;}}const Se=".empty-block",Te=new F({name:"Profile Page",description:"Shows a user's spy on their profile page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.pathname==="/profiles.php"},start:async function(){const n=await v(Se,15e3);if(n===null){l.warn(`${this.name}: Could not find the empty block on the profile page`);return}if(!d.get("tsc-key")){const a=$("<a>").attr("href",`https://www.torn.com/profiles.php?XID=${await fe()}`).text("your own profile");$(n).append($("<div>").html("Please enter your TSC API key on ").append(a).append(".")).css({display:"flex","justify-content":"center","align-items":"center"});return}const t=window.location.search.split("XID=")[1];if(!t){l.error(`${this.name}: Could not find the user's ID`);return}$(n).append($("<img>").addClass("tsc-loader")).css({display:"flex","justify-content":"center","align-items":"center"});const e=await M(t);if($(n).empty(),"error"in e||e.success!==!0){l.error(`${this.name}: Failed to fetch spy`,e),"error"in e?$(n).append($("<div>").text(e.message)):$(n).append($("<div>").text(ue(e.code)));return}const{estimate:o,statInterval:r}=e.spy;$(n).append($("<table>").addClass("tsc-stat-table").attr("title",`Inteval: ${r!=null&&r.lastUpdated?new Date(r.lastUpdated).toLocaleString():"N/A"}<br>Estimate: ${new Date(o.lastUpdated).toLocaleString()}<br>Cache: ${new Date(e.insertedAt).toLocaleString()}`).append($("<tr>").append($("<th>").text("Estimated Stats")).append($("<th>").text("Min")).append($("<th>").text("Max")).append($("<th>").text("Battle Score")).append($("<th>").text("Fair Fight"))).append($("<tr>").append($("<td>").text(b(BigInt(o.stats)))).append($("<td>").text(r!=null&&r.battleScore?b(BigInt(r.min)):"N/A")).append($("<td>").text(r!=null&&r.battleScore?b(BigInt(r.max)):"N/A")).append($("<td>").text(r!=null&&r.battleScore?b(r.battleScore):"N/A")).append($("<td>").text(r!=null&&r.battleScore?r.fairFight:"N/A"))));}}),Ce=".faction-info-wrap.restyle.another-faction .table-body > li:nth-child(1)",ve='[class*="userInfoBox"]',Oe='a[href^="/profiles.php?XID="]',ke=new F({name:"Faction - Normal",description:"Shows a list of spies on the faction page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.href.includes("factions.php?step=profile")},start:async function(){const n=await v(Ce,15e3);if(n===null){l.warn(`${this.name}: Failed to find element to append to.`);return}const t=$(n).parent()[0];$(t).children("li").each((e,o)=>{const r=$(o).find(ve)[0];//! This is a bit of a hack, but it works for now
	if($(r).css("width","169px"),$(r).css("overflow","hidden"),$(r).css("text-overflow","ellipsis"),r===void 0){l.debug(`${this.name}: Failed to find the player's profile box.`,o);return}const a=$(r).find(Oe)[0];if(a===void 0){l.debug(`${this.name}: Failed to find user's ID`,r);return}const s=a.href.split("XID=")[1];M(s).then(c=>{if("error"in c||c.success!==!0){l.warn(`${this.name}: Failed to find spy for ${s}`,c);return}const{spyText:u,tooltipText:m}=Y(c);$(r).after($("<div>").addClass("tsc-faction-spy").text(u).attr("title",m));});});}}),Q=(n,t)=>Array.prototype.slice.call(n,t);let _=null;typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope?_=self:typeof global<"u"?_=global:window&&(_=window);const L=_,U=_.document,ee=["load","loadend","loadstart"],J=["progress","abort","error","timeout"],pe=n=>["returnValue","totalSize","position"].includes(n),X=function(n,t){for(let e in n){if(pe(e))continue;const o=n[e];try{t[e]=o;}catch{}}return t},te=function(n,t,e){const o=r=>function(a){const s={};for(let c in a){if(pe(c))continue;const u=a[c];s[c]=u===t?e:u;}return e.dispatchEvent(r,s)};for(let r of Array.from(n))e._has(r)&&(t[`on${r}`]=o(r));},De=function(n){if(U&&U.createEventObject!=null){const t=U.createEventObject();return t.type=n,t}try{return new Event(n)}catch{return {type:n}}},q=function(n){let t={};const e=r=>t[r]||[],o={};return o.addEventListener=function(r,a,s){t[r]=e(r),!(t[r].indexOf(a)>=0)&&(s=s===void 0?t[r].length:s,t[r].splice(s,0,a));},o.removeEventListener=function(r,a){if(r===void 0){t={};return}a===void 0&&(t[r]=[]);const s=e(r).indexOf(a);s!==-1&&e(r).splice(s,1);},o.dispatchEvent=function(){const r=Q(arguments),a=r.shift();n||(r[0]=X(r[0],De(a)),Object.defineProperty(r[0],"target",{writable:!1,value:this}));const s=o[`on${a}`];s&&s.apply(o,r);const c=e(a).concat(e("*"));for(let u=0;u<c.length;u++)c[u].apply(o,r);},o._has=r=>!!(t[r]||o[`on${r}`]),n&&(o.listeners=r=>Q(e(r)),o.on=o.addEventListener,o.off=o.removeEventListener,o.fire=o.dispatchEvent,o.once=function(r,a){var s=function(){return o.off(r,s),a.apply(null,arguments)};return o.on(r,s)},o.destroy=()=>t={}),o},he=`\r
`,Re=function(n){return Object.entries(n).map(([o,r])=>`${o.toLowerCase()}: ${r}`).join(he)},Ie=function(n,t){const e=n.split(he);t==null&&(t={});for(let o of e)if(/([^:]+):\s*(.+)/.test(o)){const r=RegExp.$1!=null?RegExp.$1.toLowerCase():void 0,a=RegExp.$2;t[r]==null&&(t[r]=a);}return t},Le=function(n,t){switch(typeof n){case"object":return Re(n);case"string":return Ie(n,t)}return []};var W={convert:Le};const P=q(!0),ne=n=>n===void 0?null:n,N=L.XMLHttpRequest,D=function(){const t=new N,e={};let o=null,r,a,s;var c=0;const u=function(){if(s.status=o||t.status,o!==-1&&(s.statusText=t.statusText),o!==-1){const f=W.convert(t.getAllResponseHeaders());for(let p in f){const g=f[p];if(!s.headers[p]){const w=p.toLowerCase();s.headers[w]=g;}}return}},m=function(){if(!t.responseType||t.responseType==="text"){s.text=t.responseText,s.data=t.responseText;try{s.xml=t.responseXML;}catch{}}else t.responseType==="document"?(s.xml=t.responseXML,s.data=t.responseXML):s.data=t.response;"responseURL"in t&&(s.finalUrl=t.responseURL);},y=function(){i.status=s.status,i.statusText=s.statusText;},T=function(){"text"in s&&(i.responseText=s.text),"xml"in s&&(i.responseXML=s.xml),"data"in s&&(i.response=s.data),"finalUrl"in s&&(i.responseURL=s.finalUrl);},h=function(){r||i.dispatchEvent("load",{}),i.dispatchEvent("loadend",{}),r&&(i.readyState=0);},E=function(f){for(;f>c&&c<4;)i.readyState=++c,c===1&&i.dispatchEvent("loadstart",{}),c===2&&y(),c===4&&(y(),T()),i.dispatchEvent("readystatechange",{}),c===4&&(e.async===!1?h():setTimeout(h,0));},k=function(f){if(f!==4){E(f);return}const p=P.listeners("after");var g=function(){if(p.length>0){const w=p.shift();w.length===2?(w(e,s),g()):w.length===3&&e.async?w(e,s,g):g();}else E(4);};g();};var i=q();e.xhr=i,t.onreadystatechange=function(f){try{t.readyState===2&&u();}catch{}t.readyState===4&&(a=!1,u(),m()),k(t.readyState);};const O=function(){r=!0;};i.addEventListener("error",O),i.addEventListener("timeout",O),i.addEventListener("abort",O),i.addEventListener("progress",function(f){c<3?k(3):t.readyState<=3&&i.dispatchEvent("readystatechange",{});}),"withCredentials"in t&&(i.withCredentials=!1),i.status=0;for(let f of Array.from(J.concat(ee)))i[`on${f}`]=null;if(i.open=function(f,p,g,w,H){c=0,r=!1,a=!1,e.headers={},e.headerNames={},e.status=0,e.method=f,e.url=p,e.async=g!==!1,e.user=w,e.pass=H,s={},s.headers={},k(1);},i.send=function(f){let p,g;for(p of ["type","timeout","withCredentials"])g=p==="type"?"responseType":p,g in i&&(e[p]=i[g]);e.body=f;const w=function(){te(J,t,i),i.upload&&te(J.concat(ee),t.upload,i.upload),a=!0,t.open(e.method,e.url,e.async,e.user,e.pass);for(p of ["type","timeout","withCredentials"])g=p==="type"?"responseType":p,p in e&&(t[g]=e[p]);for(let C in e.headers){const R=e.headers[C];C&&t.setRequestHeader(C,R);}t.send(e.body);},H=P.listeners("before");var Z=function(){if(!H.length)return w();const C=function(S){if(typeof S=="object"&&(typeof S.status=="number"||typeof s.status=="number")){X(S,s),"data"in S||(S.data=S.response||S.text),k(4);return}Z();};C.head=function(S){X(S,s),k(2);},C.progress=function(S){X(S,s),k(3);};const R=H.shift();R.length===1?C(R(e)):R.length===2&&e.async?R(e,C):C();};Z();},i.abort=function(){o=-1,a?t.abort():i.dispatchEvent("abort",{});},i.setRequestHeader=function(f,p){const g=f!=null?f.toLowerCase():void 0,w=e.headerNames[g]=e.headerNames[g]||f;e.headers[w]&&(p=e.headers[w]+", "+p),e.headers[w]=p;},i.getResponseHeader=f=>ne(s.headers[f?f.toLowerCase():void 0]),i.getAllResponseHeaders=()=>ne(W.convert(s.headers)),t.overrideMimeType&&(i.overrideMimeType=function(){t.overrideMimeType.apply(t,arguments);}),t.upload){let f=q();i.upload=f,e.upload=f;}return i.UNSENT=0,i.OPENED=1,i.HEADERS_RECEIVED=2,i.LOADING=3,i.DONE=4,i.response="",i.responseText="",i.responseXML=null,i.readyState=0,i.statusText="",i};D.UNSENT=0;D.OPENED=1;D.HEADERS_RECEIVED=2;D.LOADING=3;D.DONE=4;var z={patch(){N&&(L.XMLHttpRequest=D);},unpatch(){N&&(L.XMLHttpRequest=N);},Native:N,Xhook:D};function Fe(n,t){var e={};for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&t.indexOf(o)<0&&(e[o]=n[o]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,o=Object.getOwnPropertySymbols(n);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(n,o[r])&&(e[o[r]]=n[o[r]]);return e}function Ne(n,t,e,o){function r(a){return a instanceof e?a:new e(function(s){s(a);})}return new(e||(e=Promise))(function(a,s){function c(y){try{m(o.next(y));}catch(T){s(T);}}function u(y){try{m(o.throw(y));}catch(T){s(T);}}function m(y){y.done?a(y.value):r(y.value).then(c,u);}m((o=o.apply(n,[])).next());})}const A=L.fetch;function Ae(n){const t=["method","headers","body","mode","credentials","cache","redirect","referrer","referrerPolicy","integrity","keepalive","signal","url"];let e={};return t.forEach(o=>e[o]=n[o]),e}function re(n){return n instanceof Headers?oe([...n.entries()]):Array.isArray(n)?oe(n):n}function oe(n){return n.reduce((t,[e,o])=>(t[e]=o,t),{})}const se=function(n,t={headers:{}}){let e=Object.assign(Object.assign({},t),{isFetch:!0});if(n instanceof Request){const a=Ae(n),s=Object.assign(Object.assign({},re(a.headers)),re(e.headers));e=Object.assign(Object.assign(Object.assign({},a),t),{headers:s,acceptedRequest:!0});}else e.url=n;const o=P.listeners("before"),r=P.listeners("after");return new Promise(function(a,s){let c=a;const u=function(h){if(!r.length)return c(h);const E=r.shift();return E.length===2?(E(e,h),u(h)):E.length===3?E(e,h,u):u(h)},m=function(h){if(h!==void 0){const E=new Response(h.body||h.text,h);a(E),u(E);return}y();},y=function(){if(!o.length){T();return}const h=o.shift();if(h.length===1)return m(h(e));if(h.length===2)return h(e,m)},T=()=>Ne(this,void 0,void 0,function*(){const{url:h,isFetch:E,acceptedRequest:k}=e,i=Fe(e,["url","isFetch","acceptedRequest"]);return n instanceof Request&&i.body instanceof ReadableStream&&(i.body=yield new Response(i.body).text()),A(h,i).then(O=>u(O)).catch(function(O){return c=s,u(O),s(O)})});y();})};var V={patch(){A&&(L.fetch=se);},unpatch(){A&&(L.fetch=A);},Native:A,Xhook:se};const x=P;x.EventEmitter=q;x.before=function(n,t){if(n.length<1||n.length>2)throw "invalid hook";return x.on("before",n,t)};x.after=function(n,t){if(n.length<2||n.length>3)throw "invalid hook";return x.on("after",n,t)};x.enable=function(){z.patch(),V.patch();};x.disable=function(){z.unpatch(),V.unpatch();};x.XMLHttpRequest=z.Native;x.fetch=V.Native;x.headers=W.convert;x.enable();const ae='[class^="warListItem"][class*="first-in-row"]',G='[class^="chain-attacks-list"]',_e='[class^="honorWrap"]',K=async()=>{$(`${G} li`).each(function(n,t){const e=$(t).find(_e);for(let o=0;o<=1;o++){const r=e[o],a=$(r).find("a").attr("href");if(!a){l.warn("Faction - Chain: Failed to find ID.");return}const s=a.split("XID=")[1];M(s).then(c=>{if("error"in c||c.success!==!0){l.warn(`Faction - Chain: Failed to find spy for ${s}`,c);return}const{spyText:u,tooltipText:m}=Y(c);$(r).find(".tsc-chain-spy").length>0||$(r).append($("<div>").addClass("tsc-chain-spy").text(u).attr("title",m));});}});},Pe=new F({name:"Faction - Chain",description:"Shows spies on the chain page",shouldRun:async function(){return !d.getToggle(this.name)||!window.location.href.includes("factions.php?step=your")?!1:await v(ae,15e3)!==null},start:async function(){let n=null;if(x.after(async(t,e)=>{if(t.url.includes("warID=chain")===!1)return;l.debug(`${this.name}: Found Chain War users request:`,t.url);const o=await v(G,15e3);if(!o){l.error(`${this.name}: Could not find attacks list (element did not show up in time)`);return}n!==null&&(n.disconnect(),n=null),await K(),n=new MutationObserver(async r=>{let a=!1;$(`${ae} li`).each(function(s,c){a!==!0&&$(c).find(".tsc-chain-spy").length===0&&(a=!0,K());});}),n.observe(o,{childList:!0,subtree:!0});}),window.location.href.includes("war/chain")){if(!await v(G,15e3)){l.error(`${this.name}: Could not find attacks list (element did not show up in time)`);return}await K();}}}),Me="#mainContainer > div.content-wrapper.spring > div.employees-wrap > ul",He='a[href^="/profiles.php?XID="]',je=new F({name:"Company Page",description:"Shows a user spies on the company page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.pathname==="/joblist.php"&&window.location.hash.includes("p=corpinfo")},start:async function(){const n=await v(Me,15e3);if(n===null){l.warn(`${this.name}: Failed to find element to append to.`);return}l.debug(`${this.name}: Found users`,n),$(n).children("li").each((t,e)=>{const o=$(e).find(He)[0];if(o===void 0){l.debug(`${this.name}: Failed to find user's ID`,e);return}const r=o.href.split("XID=")[1];l.debug(`${this.name}: Found user ID`,r),M(r).then(a=>{if("error"in a||a.success!==!0){l.warn(`${this.name}: Failed to find spy for ${r}`,a);return}const{spyText:s,tooltipText:c}=Y(a);$(o).after($("<div>").addClass("tsc-company-spy").text(s).attr("title",c));});});}}),Be='a[href^="/profiles.php?XID="]',Xe='[class*="userInfoBox"]',ie="div.member.icons.left",ce=async n=>{if(!await v(ie,1e4)){l.error(`${n}: Could not find users`);return}$(ie).each((e,o)=>{const r=$(o).find(Be)[0];if(!r){l.error(`${n}: Could not find the user's Href`);return}const a=r.href.split("XID=")[1];if(!a){l.error(`${n}: Could not find the user's ID`);return}if(!$(o).find(Xe)[0]){l.debug(`${n}: Could not find member's info box.`);return}if($(o).parent().find(".tsc-faction-war").length>0)return;const c=$("<div>").addClass("tsc-faction-war");c.append($("<img>").addClass("tsc-loader")),$(o).parent().append(c),M(a).then(u=>{if(c.empty(),"error"in u||u.success!==!0){l.warn(`${n}: Failed to find spy for ${a}`,u),"error"in u?$(c).append($("<span>").text(u.message)):$(c).append($("<span>").text(ue(u.code)));return}const{longTextInterval:m,longTextEstimate:y,toolTipText:T}=Ee(u);c.attr("title",T).append($("<span>").text(y)),m!==""&&$(c).append($("<span>").text(m)),$(o).parent().append(c);});});},qe=new F({name:"Faction - War",description:"Shows spies on the faction war page",shouldRun:async function(){return d.getToggle(this.name)&&window.location.href.includes("factions.php?step=")},start:async function(){x.after(async(n,t)=>{n.url.includes("&warID=rank")!==!1&&(l.debug(`${this.name}: Found Ranked War users request: ${n.url}`),await ce(this.name));}),window.location.href.includes("/war/rank")&&await ce(this.name);}}),ge=Object.freeze(Object.defineProperty({__proto__:null,CompanyPage:je,FactionChain:Pe,FactionNormal:ke,FactionWar:qe,ProfilePage:Te},Symbol.toStringTag,{value:"Module"})),Ue=".profile-wrapper",le=new F({name:"Settings Panel",description:"Adds a settings panel to your own profile page.",shouldRun:async function(){var e;if(window.location.href.includes("profiles.php?XID=")===!1)return !1;const n=(e=window.location.href.match(/XID=(\d+)/))==null?void 0:e[1],t=await fe();return n===t},start:async function(){var o;const n=await v(Ue,15e3);if(n===null){l.warn(`${this.name}: Failed to find element to append to.`);return}if((o=n.nextElementSibling)!=null&&o.classList.contains("tsc-accordion")){l.warn(`${this.name}: Element already exists`);return}const t=await be(),e="error"in t?$("<div>").text("Welcome!"):$("<div>").html(`Hey, ${$("<div>").addClass("tsc-header-username").text(t.name).prop("outerHTML")}!`);$(n).after($("<details>").addClass("tsc-accordion").addClass(d.get("tsc-key")?"":"tsc-glow").append($("<summary>").text("TSC Settings")).append($("<div>").addClass("tsc-header").append(e),$("<p>").css("margin-top","5px").text("This is the settings panel for the Torn Spies Central script."),$("<p>").text("Here you can configure the settings to your liking. Please note that changes will be saved automatically."),$("<p>").css("margin-top","5px").text("Note: Currently, the script works best with honor bars turned off. If you have them on, all spies (except on the profile page) will be unreadable. You can manage this in Settings -> General Settings -> Honor Names -> Off"),$("<br>"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","enabled").prop("checked",d.getToggle("enabled")).on("change",function(){d.set("enabled",$(this).prop("checked"));})).append($("<p>").text("Enable Script")),$("<div>").addClass("tsc-setting-entry").append($("<label>").attr("for","api-key").text("API Key"),$("<input>").attr("type","text").attr("id","api-key").attr("placeholder","Paste your key here...").addClass("tsc-key-input").addClass(d.get("tsc-key")?"tsc-blur":"").val(d.get("tsc-key")||"").on("change",function(){const r=$(this).val();if(typeof r=="string"){if(!/^[a-zA-Z0-9]{16}$/.test(r)){$(this).css("outline","1px solid red");return}$(this).css("outline","none"),r!==d.get("tsc-key")&&d.set("tsc-key",r);}})),$("<br>"),$("<p>").text("Feature toggles:"),Object.values(ge).map(r=>$("<div>").append($("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id",r.name).prop("checked",d.getToggle(r.name)).on("change",function(){d.set(r.name,$(this).prop("checked"));})).append($("<p>").text(r.name))).append($("<p>").text(r.description))),$("<br>"),$("<p>").text("The following buttons require a confirmation before anything is deleted.").css("margin-bottom","10px"),$("<button>").text("Clear cached spies").addClass("tsc-button").css("margin-right","10px").on("click",async function(){if(!confirm("Are you sure you want to clear cached spies?"))return;const a=d.spyClear();l.debug(`Cleared ${a} spies from cache.`);const s=$(this);s.animate({opacity:0},"slow",function(){s.text(`Cleared ${a} spies`);}).animate({opacity:1},"slow"),setTimeout(function(){s.animate({opacity:0},"slow",function(){s.text("Clear cached spies");}).animate({opacity:1},"slow");},3e3);}),$("<button>").text("Clear all cache").addClass("tsc-button").on("click",async function(){if(!confirm("Are you sure you want to clear all cache?"))return;const a=d.fullClear();l.debug(`Cleared ${a} items in cache.`);const s=$(this);s.animate({opacity:0},"slow",function(){s.text(`Cleared ${a} items`);}).animate({opacity:1},"slow"),setTimeout(function(){s.animate({opacity:0},"slow",function(){s.text("Clear all cache");}).animate({opacity:1},"slow");},3e3);}),$("<br>"),$("<br>"),$("<p>").text("Debug settings:"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","debug-logs").prop("checked",d.getToggle("debug-logs")).on("change",function(){d.set("debug-logs",$(this).prop("checked"));})).append($("<p>").text("Extra debug logs"))));}});async function Je(){if(await le.shouldRun()===!0&&(l.info("Settings panel initialized"),await le.start()),d.getToggle("enabled")===!1){l.info("TSC is disabled");return}l.info("Starting TSC features...");for(const n of Object.values(ge))if(await n.shouldRun()!==!1)try{await n.start(),l.info(`'${n.name}' started`);}catch(t){l.error(`Failed to start '${n.name}'`,t);}}Je().catch(n=>{l.error("TSC failed catastrophically:",n);});

})();