// ==UserScript==
// @name         TSC Companion - Next
// @namespace    TSC
// @version      next-11
// @author       mavri [2402357]
// @description  A very early version of the new TSC Companion. Special thanks to Kwack [2190604]
// @copyright    2024, diicot.cc
// @icon         https://i.imgur.com/8eydsOA.png
// @updateURL    https://github.com/LeoMavri/TSC-Companion/raw/next/dist/tsc-companion.user.js
// @match        https://www.torn.com/profiles.php?*
// @match        https://www.torn.com/factions.php*
// @match        https://www.torn.com/joblist.php*
// @connect      api.torn.com
// @connect      tsc.diicot.cc
// @grant        GM.xmlHttpRequest
// @grant        GM_addStyle
// @run-at       document-end
// ==/UserScript==

(o=>{if(typeof GM_addStyle=="function"){GM_addStyle(o);return}const r=document.createElement("style");r.textContent=o,document.head.append(r)})(" body{--tsc-bg-color: #f0f0f0;--tsc-border-color: #ccc;--tsc-input-color: #ccc;--tsc-text-color: #000;--tsc-hover-color: #ddd}body.dark-mode{--tsc-bg-color: #333;--tsc-border-color: #444;--tsc-input-color: #504f4f;--tsc-text-color: #ccc;--tsc-hover-color: #555}table.tsc-stat-table{width:100%;border-collapse:collapse;color:var(--tsc-text-color);background-color:var(--tsc-bg-color)}table.tsc-stat-table th,table.tsc-stat-table td{border:1px solid var(--tsc-border-color);color:var(--tsc-text-color);padding:4px;text-align:center}table.tsc-stat-table th{background-color:var(--tsc-bg-color);color:var(--tsc-text-color)}.tsc-faction-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;margin-left:auto;margin-right:2px}.tsc-chain-spy{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);font-size:10px;display:flex;vertical-align:middle;justify-content:center;align-items:center;width:200%;height:15px;border-radius:5px;padding:3px;margin-left:2px;cursor:pointer}.respect{margin-left:32px!important}.attack-number{min-width:45px!important}.tsc-company-spy{display:inline;background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);border-radius:5px;padding:3px 5px;cursor:pointer;margin-left:5px}.tsc-accordion{background-color:var(--tsc-bg-color);border:1px solid var(--tsc-border-color);border-radius:5px;margin:10px 0;padding:10px}.tsc-header{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:1.2em;margin-top:10px;margin-bottom:10px}.tsc-header-username{font-style:italic;display:inline}.tsc-setting-entry{display:flex;align-items:center;gap:5px;margin-top:10px;margin-bottom:5px}.tsc-key-input{width:120px;padding-left:5px;background-color:var(--tsc-input-color);color:var(--tsc-text-color)}.tsc-button{background-color:var(--tsc-bg-color);color:var(--tsc-text-color);border:1px solid var(--tsc-border-color);transition:background-color .5s;border-radius:5px;padding:5px 10px;cursor:pointer}.tsc-button:hover{background-color:var(--tsc-hover-color);transition:background-color .5s}.tsc-blur{filter:blur(3px);transition:filter 2s}.tsc-blur:focus,.tsc-blur:active{transition-duration:.5s;filter:blur(0)} ");

(function () {
	'use strict';

	var v=Object.defineProperty;var I=(a,e,t)=>e in a?v(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var p=(a,e,t)=>(I(a,typeof e!="symbol"?e+"":e,t),t);class R{constructor(e){p(this,"storageKey");this.storageKey=e;}get(e){return localStorage.getItem(`${this.storageKey}-${e}`)}set(e,t){localStorage.setItem(`${this.storageKey}-${e}`,t);}getToggle(e){return this.get(e)==="true"}getJSON(e){const t=this.get(e);return t===null?null:JSON.parse(t)}setJSON(e,t){this.set(e,JSON.stringify(t));}fullClear(){let e=0;for(let t=0;t<localStorage.length;t++){const o=localStorage.key(t);o!=null&&o.startsWith(this.storageKey)&&(localStorage.removeItem(o),++e);}return e}spyClear(){let e=0;for(let t=0;t<localStorage.length;t++){const o=localStorage.key(t);o!=null&&o.startsWith(`${this.storageKey}-spy`)&&(localStorage.removeItem(o),++e);}return e}}const i=new R("kwack.mavri.tsc.rocks"),b={Colours:{Info:"#05668D",Warn:"#EDDEA4",Error:"#ff0000",Debug:"#5C415D"}};class s{static info(e,...t){console.info(`%c[TSC Companion] ${e}`,`color: ${b.Colours.Info}`,...t);}static warn(e,...t){console.log(`%c[TSC Companion] ${e}`,`color: ${b.Colours.Warn}`,...t);}static error(e,...t){console.error(`%c[TSC Companion] ${e}`,`color: ${b.Colours.Error}`,...t);}static debug(e,...t){i.getToggle("debug-logs")&&console.log(`%c[TSC Companion] ${e}`,`color: ${b.Colours.Debug}`,...t);}}const O=12*60*60*1e3;function S(a){const e=i.getJSON(`spy-${a}`);if(e){if(e.insertedAt&&new Date().getTime()-new Date(e.insertedAt).getTime()<O)return s.debug("Spy cache still valid"),Promise.resolve(e);s.debug("Spy cache expired, fetching new data"),i.setJSON(`spy-${a}`,null);}return new Promise((t,o)=>{(GM.xmlHttpRequest??GM.xmlhttpRequest)({method:"POST",url:"https://tsc.diicot.cc/stats/update",timeout:15e3,headers:{authorization:"10000000-6000-0000-0009-000000000001","x-requested-with":"XMLHttpRequest","Content-Type":"application/json"},data:JSON.stringify({apiKey:i.get("tsc-key")??"",userId:a}),responseType:"json",onload(r){const c=r.response;!("error"in c)&&c.success&&i.setJSON(`spy-${a}`,{...c,insertedAt:new Date().getTime()}),t(c);},onerror(r){t({error:!0,message:`Failed to fetch spy: ${r.statusText}`});},onabort(){t({error:!0,message:"Request aborted"});},ontimeout(){t({error:!0,message:"Request timed out"});}});})}async function N(){if(i.get("tsc-key")===null)return {error:!0,message:"API Key not set"};const a=i.getJSON("user-data");if(a){if(a.insertedAt&&new Date().getTime()-new Date(a.insertedAt).getTime()<O)return s.debug("User data cache still valid"),a;s.debug("User data cache expired, fetching new data"),i.setJSON("user-data",null);}const e=await fetch(`https://api.torn.com/user/?selections=basic&key=${i.get("tsc-key")}&comment=TSC-Next`);if(!e.ok)return {error:!0,message:e.statusText};const t=await e.json();return t.error?{error:!0,message:t.error.error}:(i.setJSON("user-data",{...t,insertedAt:new Date().getTime()}),t)}function h(a,e){return new Promise((t,o)=>{let n;if(document.querySelectorAll(a).length)return t(document.querySelector(a));const r=new MutationObserver(()=>{if(document.querySelectorAll(a).length)return r.disconnect(),n!=null&&clearTimeout(n),t(document.querySelector(a))});r.observe(document.body,{childList:!0,subtree:!0}),e&&(n=setTimeout(()=>{r.disconnect(),t(null);},e));})}function l(a,e=2){return Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:e,minimumFractionDigits:e}).format(a)}function x(a){const{estimate:e,statInterval:t}=a.spy;let o=l(e.stats,1),n=`Estimate: ${l(e.stats,2)}`;return t!=null&&t.battleScore&&(o=`${l(BigInt(t.min),1)} - ${l(BigInt(t.max),1)}`,n+=`<br>Interval: ${l(BigInt(t.min),2)} - ${l(BigInt(t.max),2)}<br>Battle Score: ${l(t.battleScore,2)}`),{spyText:o,tooltipText:n}}class g{constructor({name:e,description:t,shouldRun:o,start:n}){p(this,"name");p(this,"description");p(this,"shouldRun");p(this,"start");this.name=e,this.description=t,this.shouldRun=o,this.start=n;}}const L=".empty-block",M=new g({name:"Profile Page",description:"Shows a user's spy on their profile page",shouldRun:async function(){return i.getToggle(this.name)&&window.location.pathname==="/profiles.php"},start:async function(){const a=await h(L,15e3);if(a===null){s.warn(`${this.name}: Could not find the empty block on the profile page`);return}const e=window.location.search.split("XID=")[1],t=await S(e);if("error"in t){s.error(`${this.name}: Failed to fetch spy`,t);return}if(t.success!==!0){s.error(`${this.name}: Failed to fetch spy`,t);return}const{estimate:o,statInterval:n}=t.spy;$(a).append($("<table>").addClass("tsc-stat-table").attr("title",`Inteval: ${n!=null&&n.lastUpdated?new Date(n.lastUpdated).toLocaleString():"N/A"}<br>Estimate: ${new Date(o.lastUpdated).toLocaleString()}<br>Cache: ${new Date(t.insertedAt).toLocaleString()}`).append($("<tr>").append($("<th>").text("Estimated Stats")).append($("<th>").text("Min")).append($("<th>").text("Max")).append($("<th>").text("Battle Score")).append($("<th>").text("Fair Fight"))).append($("<tr>").append($("<td>").text(l(BigInt(o.stats)))).append($("<td>").text(n!=null&&n.battleScore?l(BigInt(n.min)):"N/A")).append($("<td>").text(n!=null&&n.battleScore?l(BigInt(n.max)):"N/A")).append($("<td>").text(n!=null&&n.battleScore?l(n.battleScore):"N/A")).append($("<td>").text(n!=null&&n.battleScore?n.fairFight:"N/A"))));}}),P=".faction-info-wrap.restyle.another-faction .table-body > li:nth-child(1)",B='[class*="userInfoBox"]',q='a[href^="/profiles.php?XID="]',H=new g({name:"Faction - Normal",description:"Shows a list of spies on the faction page",shouldRun:async function(){return i.getToggle(this.name)&&window.location.href.includes("factions.php?step=profile")},start:async function(){const a=await h(P,15e3);if(a===null){s.warn(`${this.name}: Failed to find element to append to.`);return}const e=$(a).parent()[0];$(e).children("li").each((t,o)=>{const n=$(o).find(B)[0];//! This is a bit of a hack, but it works for now
	if($(n).css("width","169px"),$(n).css("overflow","hidden"),$(n).css("text-overflow","ellipsis"),n===void 0){s.debug(`${this.name}: Failed to find the player's profile box.`,o);return}const r=$(n).find(q)[0];if(r===void 0){s.debug(`${this.name}: Failed to find user's ID`,n);return}const c=r.href.split("XID=")[1];S(c).then(u=>{if("error"in u||u.success!==!0){s.warn(`${this.name}: Failed to find spy for ${c}`,u);return}const{spyText:d,tooltipText:m}=x(u);$(n).after($("<div>").addClass("tsc-faction-spy").text(d).attr("title",m));});});}}),w='[class^="warListItem"][class*="first-in-row"]',k='[class^="chain-attacks-list"]',J='[class^="honorWrap"]',K=new g({name:"Faction - Chain",description:"Shows spies on the chain page",shouldRun:async function(){return !i.getToggle(this.name)||!window.location.href.includes("factions.php?step=your")?!1:await h(w)!==null},start:async function(){let a=null;const e=document.querySelector(w),t=new MutationObserver(async o=>{if(o.length===0)return;const n=document.querySelector(w);if(!(n!=null&&n.classList.contains("act")))return;s.debug(`${this.name}: Chain is active`),a!==null&&(a.disconnect(),a=null);const r=await h(k,15e3);if(!r){s.debug(`${this.name}: Could not find attacks list (element did not show up in time)`);return}const c=async()=>{$(`${k} li`).each(function(u,d){const m=$(d).find(J);for(let f=0;f<=1;f++){const C=m[f];if($(C).parent().find(".tsc-chain-spy").length>0)continue;const T=$(C).find("a").attr("href");if(!T){s.warn("Faction - Chain: Failed to find ID.");return}const E=T.split("XID=")[1];S(E).then(y=>{if("error"in y||y.success!==!0){s.warn(`Faction - Chain: Failed to find spy for ${E}`,y);return}const{spyText:A,tooltipText:_}=x(y);$(C).append($("<div>").addClass("tsc-chain-spy").text(A).attr("title",_));});}});};a=new MutationObserver(async u=>{let d=!1;$(`${w} li`).each(function(m,f){$(f).find(".tsc-chain-spy").length===0&&d===!1&&(d=!0,c());});}),await c(),a.observe(r,{childList:!0,subtree:!0});});if(!e){s.error(`${this.name}: Could not find element`);return}t.observe(e,{attributes:!0,attributeFilter:["class"]});}}),j="#mainContainer > div.content-wrapper.spring > div.employees-wrap > ul",X='a[href^="/profiles.php?XID="]',U=new g({name:"Company Page",description:"Shows a user spies on the company page",shouldRun:async function(){return i.getToggle(this.name)&&window.location.pathname==="/joblist.php"&&window.location.hash.includes("p=corpinfo")},start:async function(){const a=await h(j,15e3);if(a===null){s.warn(`${this.name}: Failed to find element to append to.`);return}s.debug(`${this.name}: Found users`,a),$(a).children("li").each((e,t)=>{const o=$(t).find(X)[0];if(o===void 0){s.debug(`${this.name}: Failed to find user's ID`,t);return}const n=o.href.split("XID=")[1];s.debug(`${this.name}: Found user ID`,n),S(n).then(r=>{if("error"in r||r.success!==!0){s.warn(`${this.name}: Failed to find spy for ${n}`,r);return}const{spyText:c,tooltipText:u}=x(r);$(o).after($("<div>").addClass("tsc-company-spy").text(c).attr("title",u));});});}}),D=Object.freeze(Object.defineProperty({__proto__:null,CompanyPage:U,FactionChain:K,FactionNormal:H,ProfilePage:M},Symbol.toStringTag,{value:"Module"})),W="#factions > ul",F=new g({name:"Settings Panel",description:"Adds a settings panel to your own faction page.",shouldRun:async function(){return window.location.href.includes("factions.php?step=your")},start:async function(){var o;const a=await h(W,15e3);if(a===null){s.warn(`${this.name}: Failed to find element to append to.`);return}if((o=a.nextElementSibling)!=null&&o.classList.contains("tsc-accordion")){s.warn(`${this.name}: Element already exists`);return}const e=await N(),t="error"in e?$("<div>").text("Welcome!"):$("<div>").html(`Hey, ${$("<div>").addClass("tsc-header-username").text(e.name).prop("outerHTML")}!`);$(a).after($("<details>").addClass("tsc-accordion").append($("<summary>").text("TSC Settings")).append($("<div>").addClass("tsc-header").append(t),$("<p>").css("margin-top","5px").text("This is the settings panel for the Torn Spies Central script."),$("<p>").text("Here you can configure the settings to your liking. Please note that changes will be saved automatically."),$("<p>").css("margin-top","5px").text("Note: Currently, the script works best with honor bars turned off. If you have them on, all spies (except on the profile page) will be unreadable. You can manage this in Settings -> General Settings -> Honor Names -> Off"),$("<br>"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","enabled").prop("checked",i.getToggle("enabled")).on("change",function(){i.set("enabled",$(this).prop("checked"));})).append($("<p>").text("Enable Script")),$("<div>").addClass("tsc-setting-entry").append($("<label>").attr("for","api-key").text("API Key"),$("<input>").attr("type","text").attr("id","api-key").attr("placeholder","Paste your key here...").addClass("tsc-key-input").addClass("tsc-blur").val(i.get("tsc-key")||"").on("change",function(){const n=$(this).val();if(typeof n=="string"){if(!/^[a-zA-Z0-9]{16}$/.test(n)){$(this).css("outline","1px solid red");return}$(this).css("outline","none"),n!==i.get("tsc-key")&&i.set("tsc-key",n);}})),$("<br>"),$("<p>").text("Feature toggles:"),Object.values(D).map(n=>$("<div>").append($("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id",n.name).prop("checked",i.getToggle(n.name)).on("change",function(){i.set(n.name,$(this).prop("checked"));})).append($("<p>").text(n.name))).append($("<p>").text(n.description))),$("<br>"),$("<p>").text("The following buttons require a confirmation before anything is deleted.").css("margin-bottom","10px"),$("<button>").text("Clear cached spies").addClass("tsc-button").css("margin-right","10px").on("click",async function(){if(!confirm("Are you sure you want to clear cached spies?"))return;const r=i.spyClear();s.debug(`Cleared ${r} spies from cache.`);const c=$(this);c.animate({opacity:0},"slow",function(){c.text(`Cleared ${r} spies`);}).animate({opacity:1},"slow"),setTimeout(function(){c.animate({opacity:0},"slow",function(){c.text("Clear cached spies");}).animate({opacity:1},"slow");},3e3);}),$("<button>").text("Clear all cache").addClass("tsc-button").on("click",async function(){if(!confirm("Are you sure you want to clear all cache?"))return;const r=i.fullClear();s.debug(`Cleared ${r} items in cache.`);const c=$(this);c.animate({opacity:0},"slow",function(){c.text(`Cleared ${r} items`);}).animate({opacity:1},"slow"),setTimeout(function(){c.animate({opacity:0},"slow",function(){c.text("Clear all cache");}).animate({opacity:1},"slow");},3e3);}),$("<br>"),$("<br>"),$("<p>").text("Debug settings:"),$("<div>").addClass("tsc-setting-entry").append($("<input>").attr("type","checkbox").attr("id","debug-logs").prop("checked",i.getToggle("debug-logs")).on("change",function(){i.set("debug-logs",$(this).prop("checked"));})).append($("<p>").text("Extra debug logs"))));}});async function z(){if(await F.shouldRun()===!0&&(s.info("Settings panel feature started"),await F.start()),i.getToggle("enabled")===!1){s.info("TSC is disabled");return}s.info("Starting TSC features...");for(const a of Object.values(D)){if(await a.shouldRun()===!1){s.debug(`${a.name} feature not applicable`);continue}try{await a.start(),s.info(`${a.name} feature started`);}catch(e){s.error(`Failed to start '${a.name}'`,e);}}}z().catch(a=>{s.error("TSC failed catastrophically:",a);});

})();